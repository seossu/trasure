<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë¶ëŒ€ ë³´ë¬¼ì°¾ê¸°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #fff; height: 100vh; overflow: hidden; }

        /* â”€â”€ ë¡œë¹„ â”€â”€ */
        #lobby {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding: 20px;
        }
        #lobby h1 {
            font-size: 3rem; margin-bottom: 10px;
            background: linear-gradient(135deg, #f5af19, #f12711);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #lobby .subtitle { color: #888; margin-bottom: 40px; font-size: 1.1rem; }
        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 500px; width: 100%; }
        .player-btn {
            position: relative; padding: 30px 20px; border: none; border-radius: 16px;
            font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer;
            transition: all 0.3s; overflow: hidden;
        }
        .player-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .player-btn.found { opacity: 0.7; }
        .player-btn.found::after {
            content: '\2705 ë°œê²¬!'; position: absolute; top: 8px; right: 12px;
            font-size: 0.8rem; background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 8px;
        }
        .player-btn .icon { font-size: 2.5rem; display: block; margin-bottom: 8px; }
        .p1 { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .p2 { background: linear-gradient(135deg, #3498db, #2980b9); }
        .p3 { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .p4 { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .bonus-section { margin-top: 40px; text-align: center; }
        .bonus-btn {
            padding: 18px 50px; border: none; border-radius: 50px;
            font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer;
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            transition: all 0.3s; opacity: 0.3; pointer-events: none;
        }
        .bonus-btn.active { opacity: 1; pointer-events: auto; animation: glow 1.5s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 10px #8e44ad; } to { box-shadow: 0 0 30px #8e44ad, 0 0 60px #9b59b6; } }
        .progress-text { margin-top: 15px; color: #aaa; font-size: 0.95rem; }

        /* â”€â”€ ê²Œì„ í™”ë©´ â”€â”€ */
        #gameView { display: none; height: 100vh; flex-direction: column; }
        #gameView.active { display: flex; }

        /* ìƒë‹¨ í—¤ë” */
        .game-header {
            background: #1a1a2e; padding: 8px 16px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0; z-index: 10;
        }
        .game-header h2 { font-size: 1rem; }
        .back-btn {
            padding: 5px 14px; border: 2px solid #fff; border-radius: 20px;
            background: transparent; color: #fff; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
        }
        .back-btn:hover { background: #fff; color: #1a1a2e; }
        .header-info { display: flex; align-items: center; gap: 16px; }
        .step-counter { font-size: 0.8rem; color: #aaa; }
        .step-counter span { color: #f5af19; font-weight: bold; }

        /* í¬ì¼“ëª¬GO ë·° ì˜ì—­ */
        .fpv-container {
            position: relative; flex: 1; min-height: 0;
            background: #87CEEB; overflow: hidden;
        }
        #fpvCanvas { width: 100%; height: 100%; display: block; }

        /* ì‹¬ë°• í…Œë‘ë¦¬ */
        .fpv-heartbeat {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 6;
            border: 4px solid transparent; transition: border-color 0.3s;
        }
        .fpv-heartbeat.warm { animation: hbWarm 1s ease-in-out infinite; }
        .fpv-heartbeat.hot { animation: hbHot 0.5s ease-in-out infinite; }
        @keyframes hbWarm { 0%,100% { border-color: transparent; } 50% { border-color: rgba(245,175,25,0.5); } }
        @keyframes hbHot { 0%,100% { border-color: transparent; } 50% { border-color: rgba(231,76,60,0.7); } }

        /* ë³´ë¬¼ ë°œê²¬ ë¹› */
        .fpv-glow {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            width: 300px; height: 300px; border-radius: 50%; pointer-events: none; z-index: 7;
            background: radial-gradient(circle, rgba(245,175,25,0.5) 0%, transparent 70%);
            animation: pulseGlow 1s ease-in-out infinite alternate;
            display: none;
        }
        @keyframes pulseGlow { 0% { transform: translate(-50%,-50%) scale(0.8); opacity: 0.5; } 100% { transform: translate(-50%,-50%) scale(1.3); opacity: 1; } }

        /* ê±°ë¦¬ í…ìŠ¤íŠ¸ (ë·° ìœ„) */
        .fpv-distance {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            z-index: 8; text-align: center; pointer-events: none;
            background: rgba(0,0,0,0.55); backdrop-filter: blur(8px);
            padding: 8px 20px; border-radius: 20px; font-size: 1.1rem; font-weight: bold;
            white-space: nowrap; color: #fff;
        }

        /* Nearby íŠ¸ë˜ì»¤ */
        .nearby-tracker {
            position: absolute; bottom: 60px; right: 12px; z-index: 8; pointer-events: none;
            background: rgba(255,255,255,0.9); border-radius: 12px; padding: 8px 12px;
            color: #333; font-size: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        .nearby-tracker.show { display: block; }
        .nearby-tracker .tracker-title { font-weight: bold; font-size: 0.65rem; color: #888; margin-bottom: 4px; }
        .nearby-tracker .tracker-icon { font-size: 1.4rem; }
        .nearby-tracker .tracker-feet { display: flex; gap: 2px; margin-top: 2px; }
        .nearby-tracker .foot { font-size: 0.55rem; }

        /* êµ¬ë¶„ì„  */
        .divider { height: 4px; background: #4FC3F7; flex-shrink: 0; }

        /* í•˜ë‹¨: ì§€ë„ + HUD */
        .map-section { position: relative; height: 35vh; flex-shrink: 0; }
        #map { width: 100%; height: 100%; }

        /* ê±·ê¸° ì¸ë””ì¼€ì´í„° */
        .walking-indicator {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: none; align-items: center; gap: 6px; pointer-events: none;
            background: rgba(26,26,46,0.9); backdrop-filter: blur(8px);
            padding: 6px 14px; border-radius: 16px; font-size: 0.8rem;
        }
        .walking-indicator.show { display: flex; }
        .walk-dots span {
            display: inline-block; width: 5px; height: 5px; background: #f5af19;
            border-radius: 50%; margin: 0 1px; animation: walkDot 0.6s ease infinite;
        }
        .walk-dots span:nth-child(2) { animation-delay: 0.15s; }
        .walk-dots span:nth-child(3) { animation-delay: 0.3s; }
        @keyframes walkDot { 0%,100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } }

        /* HUD ì˜¤ë²„ë ˆì´ (ì§€ë„ ìœ„) */
        .map-hud {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(26,26,46,0.9); backdrop-filter: blur(8px);
            padding: 10px 16px; pointer-events: none;
        }
        .hud-row { display: flex; align-items: center; justify-content: space-between; }
        .hud-left .hint-text { font-size: 0.75rem; color: #aaa; }
        .compass {
            width: 44px; height: 44px; position: relative;
            border: 2px solid rgba(255,255,255,0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .compass-arrow {
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 18px solid #e74c3c; transition: transform 0.5s ease; position: absolute;
        }
        .compass-n { position: absolute; top: 2px; font-size: 0.55rem; color: #e74c3c; font-weight: bold; }
        .distance-bar-wrap { margin-top: 6px; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .distance-bar { height: 100%; border-radius: 3px; transition: width 0.8s ease, background 0.5s; width: 0%; }

        /* í™”ë©´ í”ë“¤ë¦¼ */
        @keyframes shake {
            0%,100%{transform:translate(0)} 10%{transform:translate(-3px,-2px)} 20%{transform:translate(3px,2px)}
            30%{transform:translate(-2px,3px)} 40%{transform:translate(2px,-3px)} 50%{transform:translate(-3px,1px)}
        }
        .screen-shake { animation: shake 0.4s ease; }

        /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #16213e; border-radius: 20px; padding: 40px;
            text-align: center; max-width: 400px; width: 90%;
            animation: popIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
        }
        @keyframes popIn { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }
        .modal .treasure-icon { font-size: 5rem; margin-bottom: 15px; }
        .modal h2 { font-size: 1.8rem; margin-bottom: 10px; color: #f5af19; }
        .modal p { color: #aaa; margin-bottom: 20px; white-space: pre-line; }
        .modal button {
            padding: 12px 40px; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #f5af19, #f12711);
            color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }
        .bonus-modal h2 { color: #9b59b6; }
        .coupon {
            background: linear-gradient(135deg, #f5af19, #f12711);
            border-radius: 12px; padding: 20px; margin: 15px 0; font-size: 1.5rem; font-weight: bold;
        }
        .coupon .label { font-size: 0.85rem; opacity: 0.8; }

        /* íŒŒí‹°í´ */
        .particle {
            position: fixed; pointer-events: none; z-index: 3000;
            font-size: 1.5rem; animation: fall 2s ease-in forwards;
        }
        @keyframes fall { 0%{opacity:1;transform:translateY(0) rotate(0)} 100%{opacity:0;transform:translateY(100vh) rotate(720deg)} }
    </style>
</head>
<body>

<!-- ====== ë¡œë¹„ ====== -->
<div id="lobby">
    <h1>ğŸ—ºï¸ ë³´ë¬¼ì°¾ê¸°</h1>
    <p class="subtitle">ê²½ë¶ëŒ€í•™êµ ìº í¼ìŠ¤ - ìˆ¨ê²¨ì§„ ë³´ë¬¼ì„ ì°¾ì•„ë¼!</p>
    <div class="player-grid">
        <button class="player-btn p1" onclick="startGame(1)"><span class="icon">ğŸ”´</span>í”Œë ˆì´ì–´ 1</button>
        <button class="player-btn p2" onclick="startGame(2)"><span class="icon">ğŸ”µ</span>í”Œë ˆì´ì–´ 2</button>
        <button class="player-btn p3" onclick="startGame(3)"><span class="icon">ğŸŸ¢</span>í”Œë ˆì´ì–´ 3</button>
        <button class="player-btn p4" onclick="startGame(4)"><span class="icon">ğŸŸ¡</span>í”Œë ˆì´ì–´ 4</button>
    </div>
    <div class="bonus-section">
        <button class="bonus-btn" id="bonusBtn" onclick="showBonus()">ğŸ ë³´ë„ˆìŠ¤ ì„œë¹„ìŠ¤ ë°›ê¸°</button>
        <p class="progress-text" id="progressText">ë³´ë¬¼ ë°œê²¬: 0 / 4</p>
    </div>
</div>

<!-- ====== ê²Œì„ í™”ë©´ ====== -->
<div id="gameView">
    <div class="game-header">
        <button class="back-btn" onclick="goBack()">â† ë¡œë¹„</button>
        <h2 id="mapTitle">í”Œë ˆì´ì–´ 1</h2>
        <div class="header-info">
            <div class="step-counter">ğŸ‘£ <span id="stepCount">0</span></div>
        </div>
    </div>

    <!-- í¬ì¼“ëª¬GO ìŠ¤íƒ€ì¼ ë·° (ìƒë‹¨) -->
    <div class="fpv-container" id="fpvContainer">
        <canvas id="fpvCanvas"></canvas>
        <div class="fpv-heartbeat" id="fpvHeartbeat"></div>
        <div class="fpv-glow" id="fpvGlow"></div>
        <div class="fpv-distance" id="fpvDistance">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ íƒí—˜ì„ ì‹œì‘í•˜ì„¸ìš”</div>
        <div class="nearby-tracker" id="nearbyTracker">
            <div class="tracker-title">NEARBY</div>
            <div class="tracker-icon" id="trackerIcon">â“</div>
            <div class="tracker-feet" id="trackerFeet"></div>
        </div>
    </div>

    <div class="divider"></div>

    <!-- ì§€ë„ (í•˜ë‹¨) -->
    <div class="map-section" id="mapSection">
        <div id="map"></div>
        <div class="walking-indicator" id="walkingIndicator">
            <div class="walk-dots"><span></span><span></span><span></span></div>
            <span>ì´ë™ ì¤‘...</span>
        </div>
        <div class="map-hud">
            <div class="hud-row">
                <div class="hud-left">
                    <div class="hint-text" id="hintText">í´ë¦­í•œ ìœ„ì¹˜ë¡œ ê±¸ì–´ê°‘ë‹ˆë‹¤</div>
                </div>
                <div class="compass">
                    <span class="compass-n">N</span>
                    <div class="compass-arrow" id="compassArrow"></div>
                </div>
            </div>
            <div class="distance-bar-wrap">
                <div class="distance-bar" id="distanceBar"></div>
            </div>
        </div>
    </div>
</div>

<!-- ====== ëª¨ë‹¬ ====== -->
<div class="modal-overlay" id="foundModal">
    <div class="modal">
        <div class="treasure-icon">ğŸ‰</div>
        <h2>ë³´ë¬¼ ë°œê²¬!</h2>
        <p id="foundMsg">ì¶•í•˜í•©ë‹ˆë‹¤!</p>
        <button onclick="closeFoundModal()">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>
<div class="modal-overlay" id="bonusModal">
    <div class="modal bonus-modal">
        <div class="treasure-icon">ğŸ†ğŸŠğŸ†</div>
        <h2>ì „ì› ë³´ë¬¼ ë°œê²¬!</h2>
        <p>4ëª… ëª¨ë‘ ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤! íŠ¹ë³„ ë³´ë„ˆìŠ¤ë¥¼ ë“œë¦½ë‹ˆë‹¤!</p>
        <div class="coupon"><div class="label">íŠ¹ë³„ í• ì¸ ì¿ í°</div>ğŸ« 50% OFF</div>
        <p style="font-size:0.85rem;">ì¿ í°ì½”ë“œ: KNU-TREASURE-2026</p>
        <button onclick="closeBonusModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìƒìˆ˜ & ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAMPUS_CENTER = [35.8882, 128.6107];
const CAMPUS_BOUNDS = { latMin: 35.884, latMax: 35.893, lngMin: 128.605, lngMax: 128.617 };
const FIND_RADIUS = 50;
const WALK_SPEED = 15;
const STEP_INTERVAL = 60;

const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
const playerNames = ['í”Œë ˆì´ì–´ 1', 'í”Œë ˆì´ì–´ 2', 'í”Œë ˆì´ì–´ 3', 'í”Œë ˆì´ì–´ 4'];
const treasureEmojis = ['ğŸ’', 'ğŸ‘‘', 'ğŸº', 'â­'];

let players = Array.from({length: 4}, () => ({ found: false, treasure: null }));
let currentPlayer = null;

// Leaflet
let map = null, playerMarker = null, treasureMarker = null;
let radiusCircle = null, hintCircle = null, pathLine = null, footprints = [];

// ê±·ê¸°
let playerPos = null, walkAnimation = null, isWalking = false;
let stepCount = 0, lastBearing = 0;

// í¬ì¼“ëª¬GO ë·° (ìº”ë²„ìŠ¤)
let fpvCanvas = null, fpvCtx = null, fpvAnimFrame = null;
let fpvTime = 0, fpvWalking = false, fpvBearing = 0;
let fpvDistance = 9999, fpvFound = false;
let fpvWorldOffset = 0;  // ì›”ë“œ ìŠ¤í¬ë¡¤
let fpvObjects = [];
let fpvClouds = [];

initTreasures();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìœ í‹¸ë¦¬í‹°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000, dLat = (lat2-lat1)*Math.PI/180, dLng = (lng2-lng1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function getBearing(lat1, lng1, lat2, lng2) {
    const dLng = (lng2-lng1)*Math.PI/180;
    const y = Math.sin(dLng)*Math.cos(lat2*Math.PI/180);
    const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
              Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLng);
    return (Math.atan2(y,x)*180/Math.PI + 360) % 360;
}
function lerpLatLng(a, b, t) { return [a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t]; }
function randomCampusLocation() {
    return [
        CAMPUS_BOUNDS.latMin + Math.random()*(CAMPUS_BOUNDS.latMax - CAMPUS_BOUNDS.latMin),
        CAMPUS_BOUNDS.lngMin + Math.random()*(CAMPUS_BOUNDS.lngMax - CAMPUS_BOUNDS.lngMin)
    ];
}
function initTreasures() {
    for (let i = 0; i < 4; i++) players[i].treasure = randomCampusLocation();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í¬ì¼“ëª¬GO ìŠ¤íƒ€ì¼ ìº”ë²„ìŠ¤ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFPV() {
    fpvCanvas = document.getElementById('fpvCanvas');
    fpvCtx = fpvCanvas.getContext('2d');
    fpvTime = 0; fpvWalking = false; fpvFound = false;
    fpvDistance = 9999; fpvWorldOffset = 0;

    // ì§€í˜• ê°ì²´ (ë‚˜ë¬´, ê±´ë¬¼, ë¤ë¶ˆ, ê½ƒ)
    fpvObjects = [];
    for (let i = 0; i < 60; i++) {
        const types = ['tree','tree','building','bush','bush','flower','bench','lamp'];
        fpvObjects.push({
            type: types[Math.floor(Math.random()*types.length)],
            wx: (Math.random() - 0.5) * 1200,
            wz: Math.random() * 1000,
            baseWz: Math.random() * 1000,
            treeGreen: `hsl(${110 + Math.random()*40}, ${55+Math.random()*25}%, ${35+Math.random()*20}%)`,
            h: 20 + Math.random() * 50,
            w: 10 + Math.random() * 30,
        });
    }

    // êµ¬ë¦„
    fpvClouds = [];
    for (let i = 0; i < 6; i++) {
        fpvClouds.push({
            x: Math.random() * 1200 - 100,
            y: 20 + Math.random() * 60,
            w: 60 + Math.random() * 100,
            speed: 8 + Math.random() * 15,
        });
    }

    resizeFPV();
    window.addEventListener('resize', resizeFPV);
    renderFPV();
}

function resizeFPV() {
    if (!fpvCanvas) return;
    const c = document.getElementById('fpvContainer');
    fpvCanvas.width = c.clientWidth * window.devicePixelRatio;
    fpvCanvas.height = c.clientHeight * window.devicePixelRatio;
    fpvCtx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
}

function renderFPV() {
    if (!fpvCanvas) return;
    const W = fpvCanvas.width / window.devicePixelRatio;
    const H = fpvCanvas.height / window.devicePixelRatio;
    const ctx = fpvCtx;
    ctx.clearRect(0, 0, W, H);
    fpvTime += 0.016;

    // ê±·ê¸° â†’ ì›”ë“œ ìŠ¤í¬ë¡¤
    if (fpvWalking) fpvWorldOffset += 3;

    // ìºë¦­í„° ê±¸ìŒ ë°”ìš´ìŠ¤
    const bobY = fpvWalking ? Math.sin(fpvTime * 10) * 4 : 0;
    const bobX = fpvWalking ? Math.sin(fpvTime * 5) * 1.5 : 0;

    // â”€â”€ í•˜ëŠ˜ â”€â”€
    const skyH = H * 0.35;
    const skyGrad = ctx.createLinearGradient(0, 0, 0, skyH);
    skyGrad.addColorStop(0, '#4FC3F7');
    skyGrad.addColorStop(0.6, '#81D4FA');
    skyGrad.addColorStop(1, '#B3E5FC');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, W, skyH);

    // â”€â”€ êµ¬ë¦„ â”€â”€
    for (const cl of fpvClouds) {
        cl.x += cl.speed * 0.016;
        if (cl.x > W + 100) cl.x = -cl.w - 50;
        drawCloud(ctx, cl.x, cl.y, cl.w);
    }

    // â”€â”€ ë•… (ë¹„ìŠ¤ë“¬í•œ ì”ë””ë°­ - ë“±ê° íˆ¬ì‹œ) â”€â”€
    // ìˆ˜ë ´ì 
    const vpX = W / 2;
    const vpY = skyH;

    // ì”ë”” ì˜ì—­
    const grassGrad = ctx.createLinearGradient(0, vpY, 0, H);
    grassGrad.addColorStop(0, '#66BB6A');
    grassGrad.addColorStop(0.3, '#4CAF50');
    grassGrad.addColorStop(1, '#388E3C');
    ctx.fillStyle = grassGrad;
    ctx.fillRect(0, vpY, W, H - vpY);

    // ì”ë”” í…ìŠ¤ì²˜ íŒ¨í„´ (ì‘ì€ ì )
    ctx.fillStyle = 'rgba(56,142,60,0.4)';
    for (let i = 0; i < 120; i++) {
        const gx = (i * 97.3 + fpvWorldOffset * 0.3) % (W + 40) - 20;
        const t = (i * 73.7) % 100 / 100;
        const gy = vpY + (H - vpY) * (t * t);
        const gs = 1 + t * 3;
        ctx.beginPath();
        ctx.arc(gx, gy, gs, 0, Math.PI * 2);
        ctx.fill();
    }

    // â”€â”€ ë„ë¡œ (ì¤‘ì•™ â†’ ìˆ˜ë ´ì ) â”€â”€
    const roadW = W * 0.14;
    ctx.beginPath();
    ctx.moveTo(vpX - 3, vpY);
    ctx.lineTo(vpX - roadW, H);
    ctx.lineTo(vpX + roadW, H);
    ctx.lineTo(vpX + 3, vpY);
    ctx.closePath();
    ctx.fillStyle = '#9E9E9E';
    ctx.fill();

    // ë„ë¡œ í…Œë‘ë¦¬
    ctx.strokeStyle = '#BDBDBD';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(vpX - 3, vpY); ctx.lineTo(vpX - roadW, H);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(vpX + 3, vpY); ctx.lineTo(vpX + roadW, H);
    ctx.stroke();

    // ë„ë¡œ ì ì„  (ì´ë™ ì‹œ íë¥´ëŠ” íš¨ê³¼)
    ctx.strokeStyle = '#FFF';
    ctx.lineWidth = 2;
    ctx.setLineDash([10, 15]);
    ctx.lineDashOffset = -(fpvWorldOffset * 2) % 25;
    ctx.beginPath();
    ctx.moveTo(vpX, vpY + 5);
    ctx.lineTo(vpX, H);
    ctx.stroke();
    ctx.setLineDash([]);

    // â”€â”€ ì§€í˜• ê°ì²´ ë Œë”ë§ â”€â”€
    // z ê¸°ì¤€ ì´ë™ + ì •ë ¬
    const renderList = [];
    for (const obj of fpvObjects) {
        let z = (obj.wz - fpvWorldOffset * 0.5) % 1000;
        if (z < 0) z += 1000;
        obj._rz = z;
        renderList.push(obj);
    }
    renderList.sort((a, b) => b._rz - a._rz);

    for (const obj of renderList) {
        const z = obj._rz;
        const depthT = z / 1000; // 0(ê°€ê¹Œì›€) ~ 1(ë¨¼)
        const perspScale = 0.15 + (1 - depthT) * 0.85;

        // í™”ë©´ ì¢Œí‘œ (ì›ê·¼ íˆ¬ì‹œ)
        const screenY = vpY + (H - vpY) * (1 - depthT * depthT);
        const centerSpread = (1 - depthT) * 1.5 + depthT * 0.1;
        const screenX = vpX + obj.wx * centerSpread * 0.5;

        if (screenX < -80 || screenX > W + 80) continue;
        ctx.globalAlpha = Math.min(1, 0.3 + (1 - depthT) * 0.7);

        const s = perspScale;

        if (obj.type === 'tree') {
            // ë‚˜ë¬´ ì¤„ê¸°
            ctx.fillStyle = '#5D4037';
            const tw = 5 * s, th = 25 * s;
            ctx.fillRect(screenX - tw/2, screenY - th, tw, th);
            // ë‚˜ë­‡ì (ë‘¥ê·¼)
            ctx.fillStyle = obj.treeGreen;
            ctx.beginPath();
            ctx.arc(screenX, screenY - th - 12*s, 15*s, 0, Math.PI*2);
            ctx.fill();
            // í•˜ì´ë¼ì´íŠ¸
            ctx.fillStyle = 'rgba(255,255,255,0.15)';
            ctx.beginPath();
            ctx.arc(screenX - 4*s, screenY - th - 15*s, 6*s, 0, Math.PI*2);
            ctx.fill();
        } else if (obj.type === 'building') {
            const bw = obj.w * s * 1.5, bh = obj.h * s * 1.2;
            // ê±´ë¬¼ ë³¸ì²´ (í¬ì¼“ëª¬GO ìŠ¤íƒ€ì¼ ë¸”ë£¨ê·¸ë ˆì´)
            ctx.fillStyle = '#B0BEC5';
            ctx.fillRect(screenX - bw/2, screenY - bh, bw, bh);
            // ì§€ë¶•
            ctx.fillStyle = '#78909C';
            ctx.fillRect(screenX - bw/2 - 2*s, screenY - bh - 4*s, bw + 4*s, 6*s);
            // ì°½ë¬¸
            ctx.fillStyle = '#E3F2FD';
            const rows = Math.max(1, Math.floor(bh / (12*s)));
            const cols = Math.max(1, Math.floor(bw / (12*s)));
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    ctx.fillRect(
                        screenX - bw/2 + 3*s + c*(bw/(cols)) ,
                        screenY - bh + 8*s + r*(bh/(rows)),
                        bw/(cols) * 0.5, bh/(rows) * 0.45
                    );
                }
            }
        } else if (obj.type === 'bush') {
            ctx.fillStyle = obj.treeGreen;
            ctx.beginPath();
            ctx.ellipse(screenX, screenY - 3*s, 10*s, 7*s, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath();
            ctx.ellipse(screenX - 3*s, screenY - 5*s, 4*s, 3*s, 0, 0, Math.PI*2);
            ctx.fill();
        } else if (obj.type === 'flower') {
            const colors = ['#E91E63','#FF9800','#9C27B0','#FFEB3B','#F44336'];
            ctx.fillStyle = colors[Math.floor(obj.wx * 100) % colors.length];
            ctx.beginPath();
            ctx.arc(screenX, screenY - 2*s, 3*s, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(screenX - 0.5*s, screenY - 2*s, 1*s, 4*s);
        } else if (obj.type === 'bench') {
            ctx.fillStyle = '#795548';
            ctx.fillRect(screenX - 8*s, screenY - 4*s, 16*s, 3*s);
            ctx.fillRect(screenX - 7*s, screenY - 1*s, 2*s, 4*s);
            ctx.fillRect(screenX + 5*s, screenY - 1*s, 2*s, 4*s);
        } else if (obj.type === 'lamp') {
            ctx.fillStyle = '#616161';
            ctx.fillRect(screenX - 1*s, screenY - 30*s, 2*s, 30*s);
            ctx.fillStyle = '#FFF9C4';
            ctx.beginPath();
            ctx.arc(screenX, screenY - 30*s, 4*s, 0, Math.PI*2);
            ctx.fill();
        }
    }
    ctx.globalAlpha = 1;

    // â”€â”€ ë³´ë¬¼ (í¬ì¼“ìŠ¤í†± ìŠ¤íƒ€ì¼) â”€â”€
    if (playerPos && currentPlayer !== null && !fpvFound) {
        const treasureDist = fpvDistance;
        if (treasureDist < 400) {
            const normDist = Math.max(0, Math.min(1, treasureDist / 400));
            // ë©€ìˆ˜ë¡ ìœ„ìª½(ì‘ê²Œ), ê°€ê¹Œìš¸ìˆ˜ë¡ ì•„ë˜(í¬ê²Œ)
            const tY = vpY + (H * 0.55 - vpY) * (1 - normDist);
            const tScale = 0.4 + (1 - normDist) * 0.6;
            const tX = vpX + Math.sin(fpvBearing * Math.PI / 180) * (1 - normDist) * W * 0.15;

            // í¬ì¼“ìŠ¤í†± ê¸°ë‘¥
            ctx.fillStyle = '#90CAF9';
            ctx.fillRect(tX - 2*tScale, tY, 4*tScale, 20*tScale);

            // í¬ì¼“ìŠ¤í†± íë¸Œ (íšŒì „ íš¨ê³¼)
            const spin = fpvTime * 2;
            const cubeW = 18 * tScale;
            const cubeH = 18 * tScale;
            ctx.save();
            ctx.translate(tX, tY - 5*tScale);
            ctx.rotate(Math.sin(spin) * 0.2);

            // ë‹¤ì´ì•„ëª¬ë“œ í˜•íƒœ
            ctx.beginPath();
            ctx.moveTo(0, -cubeH);
            ctx.lineTo(cubeW, 0);
            ctx.lineTo(0, cubeH);
            ctx.lineTo(-cubeW, 0);
            ctx.closePath();
            const cubeGrad = ctx.createLinearGradient(-cubeW, -cubeH, cubeW, cubeH);
            cubeGrad.addColorStop(0, '#42A5F5');
            cubeGrad.addColorStop(0.5, '#90CAF9');
            cubeGrad.addColorStop(1, '#1E88E5');
            ctx.fillStyle = cubeGrad;
            ctx.fill();
            ctx.strokeStyle = '#1565C0';
            ctx.lineWidth = 2 * tScale;
            ctx.stroke();

            // ê°€ìš´ë° ë³´ë¬¼ ì´ëª¨ì§€
            if (treasureDist < 150) {
                ctx.font = `${14 * tScale}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(treasureEmojis[currentPlayer], 0, 0);
            }

            ctx.restore();

            // ë¹›ë‚˜ëŠ” ì›
            if (treasureDist < 100) {
                const glowR = 30 * tScale + Math.sin(fpvTime * 4) * 8 * tScale;
                const glow = ctx.createRadialGradient(tX, tY - 5*tScale, 0, tX, tY - 5*tScale, glowR);
                glow.addColorStop(0, 'rgba(66,165,245,0.4)');
                glow.addColorStop(1, 'transparent');
                ctx.fillStyle = glow;
                ctx.beginPath();
                ctx.arc(tX, tY - 5*tScale, glowR, 0, Math.PI*2);
                ctx.fill();
            }

            // ë– ë‹¤ë‹ˆëŠ” ë°˜ì§ì´ íŒŒí‹°í´
            if (treasureDist < 200) {
                for (let sp = 0; sp < 5; sp++) {
                    const angle = fpvTime * 1.5 + sp * Math.PI * 2 / 5;
                    const rad = 15 * tScale + Math.sin(fpvTime * 2 + sp) * 8 * tScale;
                    const spX = tX + Math.cos(angle) * rad;
                    const spY = tY - 5*tScale + Math.sin(angle) * rad * 0.5;
                    const alpha = 0.3 + Math.sin(fpvTime * 3 + sp) * 0.3;
                    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
                    ctx.beginPath();
                    ctx.arc(spX, spY, 2*tScale, 0, Math.PI*2);
                    ctx.fill();
                }
            }
        }
    }

    // â”€â”€ ìºë¦­í„° (í™”ë©´ í•˜ë‹¨ ì¤‘ì•™) â”€â”€
    const charX = vpX + bobX;
    const charY = H * 0.78 + bobY;
    const charColor = currentPlayer !== null ? playerColors[currentPlayer] : '#e74c3c';
    drawCharacter(ctx, charX, charY, charColor, fpvWalking, fpvTime);

    // â”€â”€ ìºë¦­í„° ì•„ë˜ ê·¸ë¦¼ì â”€â”€
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.beginPath();
    ctx.ellipse(charX, charY + 22, 16, 5, 0, 0, Math.PI*2);
    ctx.fill();

    // â”€â”€ ìºë¦­í„° ì£¼ë³€ ì› (í™œë™ ë°˜ê²½ í‘œì‹œ) â”€â”€
    ctx.strokeStyle = `${charColor}44`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(charX, charY + 15, 50, 18, 0, 0, Math.PI*2);
    ctx.stroke();

    // â”€â”€ Nearby íŠ¸ë˜ì»¤ ì—…ë°ì´íŠ¸ â”€â”€
    updateTracker();

    fpvAnimFrame = requestAnimationFrame(renderFPV);
}

// â”€â”€ êµ¬ë¦„ ê·¸ë¦¬ê¸° â”€â”€
function drawCloud(ctx, x, y, w) {
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    const h = w * 0.35;
    ctx.beginPath();
    ctx.ellipse(x, y, w * 0.5, h * 0.5, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(x - w * 0.25, y + h * 0.15, w * 0.3, h * 0.35, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(x + w * 0.25, y + h * 0.1, w * 0.35, h * 0.4, 0, 0, Math.PI * 2);
    ctx.fill();
}

// â”€â”€ ìºë¦­í„° ê·¸ë¦¬ê¸° (í¬ì¼“ëª¬GO íŠ¸ë ˆì´ë„ˆ ìŠ¤íƒ€ì¼) â”€â”€
function drawCharacter(ctx, x, y, color, walking, time) {
    const legSwing = walking ? Math.sin(time * 10) * 12 : 0;
    const armSwing = walking ? Math.sin(time * 10) * 15 : 0;

    ctx.save();
    ctx.translate(x, y);

    // ë‹¤ë¦¬ (ê±¸ì„ ë•Œ êµì°¨)
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    // ì™¼ë‹¤ë¦¬
    ctx.beginPath();
    ctx.moveTo(-4, 5);
    ctx.lineTo(-4 + Math.sin(legSwing * Math.PI/180) * 6, 20);
    ctx.stroke();
    // ì˜¤ë¥¸ë‹¤ë¦¬
    ctx.beginPath();
    ctx.moveTo(4, 5);
    ctx.lineTo(4 - Math.sin(legSwing * Math.PI/180) * 6, 20);
    ctx.stroke();

    // ì‹ ë°œ
    ctx.fillStyle = '#F44336';
    ctx.beginPath();
    ctx.ellipse(-4 + Math.sin(legSwing * Math.PI/180) * 6, 21, 4, 2.5, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(4 - Math.sin(legSwing * Math.PI/180) * 6, 21, 4, 2.5, 0, 0, Math.PI * 2);
    ctx.fill();

    // ëª¸í†µ (ìƒ‰ìƒ ì˜·)
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.roundRect(-9, -10, 18, 18, 4);
    ctx.fill();
    // ì˜· ë°ì€ ë¶€ë¶„
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.fillRect(-5, -8, 10, 4);

    // íŒ” (ê±¸ì„ ë•Œ êµì°¨)
    ctx.strokeStyle = color;
    ctx.lineWidth = 4;
    // ì™¼íŒ”
    ctx.beginPath();
    ctx.moveTo(-9, -5);
    ctx.lineTo(-14 - Math.sin(armSwing * Math.PI/180) * 4, 5 + Math.sin(armSwing * Math.PI/180) * 3);
    ctx.stroke();
    // ì˜¤ë¥¸íŒ”
    ctx.beginPath();
    ctx.moveTo(9, -5);
    ctx.lineTo(14 + Math.sin(armSwing * Math.PI/180) * 4, 5 - Math.sin(armSwing * Math.PI/180) * 3);
    ctx.stroke();

    // ì†
    ctx.fillStyle = '#FFCC80';
    ctx.beginPath();
    ctx.arc(-14 - Math.sin(armSwing * Math.PI/180) * 4, 6 + Math.sin(armSwing * Math.PI/180) * 3, 3, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(14 + Math.sin(armSwing * Math.PI/180) * 4, 6 - Math.sin(armSwing * Math.PI/180) * 3, 3, 0, Math.PI*2);
    ctx.fill();

    // ë¨¸ë¦¬
    ctx.fillStyle = '#FFCC80';
    ctx.beginPath();
    ctx.arc(0, -18, 10, 0, Math.PI * 2);
    ctx.fill();

    // ë¨¸ë¦¬ì¹´ë½/ëª¨ì
    ctx.fillStyle = '#333';
    ctx.beginPath();
    ctx.arc(0, -21, 10, Math.PI, Math.PI * 2);
    ctx.fill();
    // ëª¨ì ì±™
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.ellipse(0, -21, 13, 4, 0, 0, Math.PI * 2);
    ctx.fill();
    // ëª¨ì ìœ—ë¶€ë¶„
    ctx.beginPath();
    ctx.arc(0, -24, 9, Math.PI, Math.PI * 2);
    ctx.fill();

    // ëˆˆ
    ctx.fillStyle = '#333';
    ctx.beginPath();
    ctx.arc(-3, -17, 1.5, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(3, -17, 1.5, 0, Math.PI*2);
    ctx.fill();

    // ì… (ì›ƒëŠ” í‘œì •)
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(0, -14, 3, 0.1 * Math.PI, 0.9 * Math.PI);
    ctx.stroke();

    ctx.restore();
}

// â”€â”€ Nearby íŠ¸ë˜ì»¤ UI â”€â”€
function updateTracker() {
    const tracker = document.getElementById('nearbyTracker');
    const iconEl = document.getElementById('trackerIcon');
    const feetEl = document.getElementById('trackerFeet');

    if (!playerPos || currentPlayer === null) {
        tracker.classList.remove('show');
        return;
    }
    tracker.classList.add('show');

    // ë°œìêµ­ ìˆ˜ (3ë‹¨ê³„: ë©€ë©´ 3ê°œ, ê°€ê¹Œìš°ë©´ 0ê°œ)
    let feetCount = 3;
    if (fpvDistance <= FIND_RADIUS) feetCount = 0;
    else if (fpvDistance <= 100) feetCount = 0;
    else if (fpvDistance <= 200) feetCount = 1;
    else if (fpvDistance <= 400) feetCount = 2;

    if (fpvDistance < 200) {
        iconEl.textContent = treasureEmojis[currentPlayer];
    } else {
        iconEl.textContent = 'â“';
    }

    feetEl.innerHTML = '';
    for (let i = 0; i < feetCount; i++) {
        const span = document.createElement('span');
        span.className = 'foot';
        span.textContent = 'ğŸ¾';
        feetEl.appendChild(span);
    }
}

function updateFPVState(dist, bearing, walking, found) {
    fpvDistance = dist;
    fpvBearing = bearing;
    fpvWalking = walking;
    fpvFound = found;

    const el = document.getElementById('fpvDistance');
    const distStr = dist < 1000 ? Math.round(dist)+'m' : (dist/1000).toFixed(1)+'km';

    if (!playerPos) {
        el.textContent = 'ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ íƒí—˜ì„ ì‹œì‘í•˜ì„¸ìš”';
        el.style.color = '#fff';
    } else if (dist <= FIND_RADIUS) {
        el.innerHTML = 'ğŸ”¥ ' + distStr + ' - ë³´ë¬¼ ë°œê²¬!';
        el.style.color = '#ff6b6b';
    } else if (dist <= 100) {
        el.innerHTML = 'ğŸ”¥ ' + distStr + ' - ë§¤ìš° ê°€ê¹Œì›Œ!';
        el.style.color = '#ff6b6b';
    } else if (dist <= 200) {
        el.innerHTML = 'ğŸŒ¡ï¸ ' + distStr + ' - ê°€ê¹Œì›Œì§€ê³  ìˆì–´ìš”!';
        el.style.color = '#ffa726';
    } else if (dist <= 400) {
        el.innerHTML = 'â„ï¸ ' + distStr + ' - ì¡°ê¸ˆ ë” ê°€ì•¼í•´ìš”';
        el.style.color = '#42a5f5';
    } else {
        el.innerHTML = 'ğŸ§Š ' + distStr + ' - ë¨¼ ê³³ì´ì—ìš”';
        el.style.color = '#90caf9';
    }
}

function stopFPV() {
    if (fpvAnimFrame) cancelAnimationFrame(fpvAnimFrame);
    fpvAnimFrame = null; fpvCanvas = null; fpvCtx = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(num) {
    currentPlayer = num - 1;
    if (players[currentPlayer].found) {
        alert(playerNames[currentPlayer] + 'ì€(ëŠ”) ì´ë¯¸ ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!');
        return;
    }
    stepCount = 0; playerPos = null; footprints = []; lastBearing = 0;
    document.getElementById('stepCount').textContent = '0';
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameView').classList.add('active');
    document.getElementById('mapTitle').textContent =
        playerNames[currentPlayer] + ' ' + treasureEmojis[currentPlayer];
    document.getElementById('fpvHeartbeat').className = 'fpv-heartbeat';
    document.getElementById('fpvGlow').style.display = 'none';
    initMap();
    setTimeout(initFPV, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Leaflet ì§€ë„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap() {
    if (map) map.remove();
    map = L.map('map', { zoomControl: false }).setView(CAMPUS_CENTER, 16);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OSM', maxZoom: 19
    }).addTo(map);
    L.rectangle([
        [CAMPUS_BOUNDS.latMin, CAMPUS_BOUNDS.lngMin],
        [CAMPUS_BOUNDS.latMax, CAMPUS_BOUNDS.lngMax]
    ], { color: playerColors[currentPlayer], weight: 2, fillOpacity: 0.03, dashArray: '8 4' }).addTo(map);
    const treasure = players[currentPlayer].treasure;
    hintCircle = L.circle(treasure, {
        radius: 150, color: '#f5af19', fillColor: '#f5af19',
        fillOpacity: 0.06, weight: 1, dashArray: '4 4'
    }).addTo(map);
    pathLine = L.polyline([], {
        color: playerColors[currentPlayer], weight: 3, opacity: 0.5, dashArray: '6 8'
    }).addTo(map);
    map.on('click', onMapClick);
    document.getElementById('hintText').textContent = 'ë…¸ë€ ì ì„  ì› ì•ˆì— ë³´ë¬¼ì´ ìˆìŠµë‹ˆë‹¤!';
    document.getElementById('distanceBar').style.width = '0%';
    setTimeout(() => map.invalidateSize(), 150);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§€ë„ í´ë¦­ â†’ ê±·ê¸°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onMapClick(e) {
    const target = [e.latlng.lat, e.latlng.lng];
    if (walkAnimation) {
        clearTimeout(walkAnimation); walkAnimation = null;
        isWalking = false;
        document.getElementById('walkingIndicator').classList.remove('show');
    }
    if (!playerPos) {
        playerPos = target;
        placePlayer(playerPos);
        updateGameUI();
        return;
    }
    walkTo(target);
}

function walkTo(target) {
    const start = [...playerPos];
    const totalDist = getDistance(start[0], start[1], target[0], target[1]);
    const totalSteps = Math.max(1, Math.ceil(totalDist / WALK_SPEED));
    let currentStep = 0;
    const bearing = getBearing(start[0], start[1], target[0], target[1]);
    lastBearing = bearing;
    document.getElementById('compassArrow').style.transform = `rotate(${bearing}deg)`;
    isWalking = true;
    document.getElementById('walkingIndicator').classList.add('show');

    function step() {
        currentStep++;
        const t = Math.min(currentStep / totalSteps, 1);
        const eased = 1 - Math.pow(1 - t, 2);
        playerPos = lerpLatLng(start, target, eased);
        placePlayer(playerPos);
        pathLine.addLatLng(playerPos);
        stepCount++;
        document.getElementById('stepCount').textContent = stepCount;
        if (stepCount % 5 === 0) addFootprint(playerPos, bearing);
        map.setView(playerPos, map.getZoom(), { animate: false });
        updateGameUI();
        const treasure = players[currentPlayer].treasure;
        const dist = getDistance(playerPos[0], playerPos[1], treasure[0], treasure[1]);
        if (dist <= FIND_RADIUS) {
            isWalking = false;
            document.getElementById('walkingIndicator').classList.remove('show');
            foundTreasure();
            return;
        }
        if (currentStep < totalSteps) {
            walkAnimation = setTimeout(step, STEP_INTERVAL);
        } else {
            isWalking = false;
            document.getElementById('walkingIndicator').classList.remove('show');
            walkAnimation = null;
        }
    }
    step();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í”Œë ˆì´ì–´ ë§ˆì»¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placePlayer(pos) {
    const color = playerColors[currentPlayer];
    if (playerMarker) {
        playerMarker.setLatLng(pos);
    } else {
        const icon = L.divIcon({
            html: `<div style="width:18px;height:18px;border-radius:50%;background:${color};border:3px solid #fff;box-shadow:0 0 10px ${color};"></div>
            <div style="position:absolute;top:-3px;left:-3px;width:24px;height:24px;border-radius:50%;border:2px solid ${color};opacity:0.5;animation:ping 1.5s ease-out infinite;"></div>
            <style>@keyframes ping{0%{transform:scale(1);opacity:.5}100%{transform:scale(2.5);opacity:0}}</style>`,
            iconSize: [18,18], iconAnchor: [9,9], className: ''
        });
        playerMarker = L.marker(pos, { icon, zIndexOffset: 1000 }).addTo(map);
    }
    if (radiusCircle) { radiusCircle.setLatLng(pos); }
    else { radiusCircle = L.circle(pos, { radius: FIND_RADIUS, color, fillColor: color, fillOpacity: 0.08, weight: 1 }).addTo(map); }
}

function addFootprint(pos, bearing) {
    const icon = L.divIcon({
        html: `<div style="font-size:0.6rem;opacity:0.3;transform:rotate(${bearing}deg);">ğŸ‘£</div>`,
        iconSize: [10,10], iconAnchor: [5,5], className: ''
    });
    const m = L.marker(pos, { icon, interactive: false }).addTo(map);
    footprints.push(m);
    if (footprints.length > 30) map.removeLayer(footprints.shift());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ UI (ê±°ë¦¬, íš¨ê³¼)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGameUI() {
    if (!playerPos) return;
    const treasure = players[currentPlayer].treasure;
    const dist = getDistance(playerPos[0], playerPos[1], treasure[0], treasure[1]);
    const hintEl = document.getElementById('hintText');
    const bar = document.getElementById('distanceBar');
    const fpvHb = document.getElementById('fpvHeartbeat');
    const fpvGlow = document.getElementById('fpvGlow');
    const fpvContainer = document.getElementById('fpvContainer');

    const barPct = Math.max(0, Math.min(100, (1 - dist/500)*100));
    bar.style.width = barPct + '%';
    const bearingToTreasure = getBearing(playerPos[0], playerPos[1], treasure[0], treasure[1]);
    document.getElementById('compassArrow').style.transform = `rotate(${bearingToTreasure}deg)`;

    updateFPVState(dist, bearingToTreasure, isWalking, players[currentPlayer].found);

    if (dist <= FIND_RADIUS) {
        hintEl.textContent = '';
        bar.style.background = '#e74c3c';
        fpvHb.className = 'fpv-heartbeat hot';
        fpvGlow.style.display = 'block';
        fpvContainer.classList.add('screen-shake');
        setTimeout(() => fpvContainer.classList.remove('screen-shake'), 400);
    } else if (dist <= 100) {
        hintEl.textContent = 'ê±°ì˜ ë‹¤ ì™”ì–´ìš”! ì¡°ê¸ˆë§Œ ë”!';
        bar.style.background = 'linear-gradient(90deg,#e74c3c,#f39c12)';
        fpvHb.className = 'fpv-heartbeat hot';
        fpvGlow.style.display = 'block';
        if (Math.random() > 0.7) {
            fpvContainer.classList.add('screen-shake');
            setTimeout(() => fpvContainer.classList.remove('screen-shake'), 300);
        }
    } else if (dist <= 200) {
        hintEl.textContent = 'ê°€ê¹Œì›Œì§€ê³  ìˆì–´ìš”!';
        bar.style.background = 'linear-gradient(90deg,#f39c12,#f5af19)';
        fpvHb.className = 'fpv-heartbeat warm';
        fpvGlow.style.display = 'none';
    } else if (dist <= 400) {
        hintEl.textContent = 'ì•„ì§ ë©€ì–´ìš”...';
        bar.style.background = '#3498db';
        fpvHb.className = 'fpv-heartbeat';
        fpvGlow.style.display = 'none';
    } else {
        hintEl.textContent = 'ë„ˆë¬´ ë©€ì–´ìš”! ë‹¤ë¥¸ ë°©í–¥ìœ¼ë¡œ!';
        bar.style.background = '#2980b9';
        fpvHb.className = 'fpv-heartbeat';
        fpvGlow.style.display = 'none';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³´ë¬¼ ë°œê²¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function foundTreasure() {
    const treasure = players[currentPlayer].treasure;
    fpvFound = true;
    const icon = L.divIcon({
        html: `<div style="font-size:2.5rem;animation:bounceIn .6s cubic-bezier(.175,.885,.32,1.275);">${treasureEmojis[currentPlayer]}</div>
        <style>@keyframes bounceIn{0%{transform:scale(0) rotate(-20deg);opacity:0}60%{transform:scale(1.3) rotate(10deg)}100%{transform:scale(1) rotate(0);opacity:1}}</style>`,
        iconSize: [40,40], iconAnchor: [20,20], className: ''
    });
    treasureMarker = L.marker(treasure, { icon, zIndexOffset: 2000 }).addTo(map);
    map.flyTo(treasure, 18, { duration: 1 });
    players[currentPlayer].found = true;
    spawnParticles();
    setTimeout(() => {
        document.getElementById('foundMsg').textContent =
            playerNames[currentPlayer] + 'ì´(ê°€) ' + treasureEmojis[currentPlayer] +
            ' ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!\nì´ ' + stepCount + 'ê±¸ìŒ ì´ë™!';
        document.getElementById('foundModal').classList.add('show');
    }, 1200);
}

function spawnParticles() {
    const emojis = ['ğŸ‰','âœ¨','ğŸŒŸ','ğŸ’«','ğŸŠ','â­','ğŸ†'];
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const p = document.createElement('div');
            p.className = 'particle';
            p.textContent = emojis[Math.floor(Math.random()*emojis.length)];
            p.style.left = Math.random()*100+'vw';
            p.style.top = '-20px';
            p.style.animationDuration = (1.5+Math.random())+'s';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 3000);
        }, i*80);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë¡œë¹„ & ëª¨ë‹¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeFoundModal() {
    document.getElementById('foundModal').classList.remove('show');
    goBack();
}
function closeBonusModal() { document.getElementById('bonusModal').classList.remove('show'); }

function goBack() {
    if (walkAnimation) { clearTimeout(walkAnimation); walkAnimation = null; }
    isWalking = false;
    document.getElementById('gameView').classList.remove('active');
    document.getElementById('lobby').style.display = 'flex';
    if (map) { map.remove(); map = null; }
    playerMarker = null; treasureMarker = null; radiusCircle = null;
    hintCircle = null; pathLine = null; footprints = [];
    stopFPV();
    updateLobbyUI();
}

function updateLobbyUI() {
    const btns = document.querySelectorAll('.player-btn');
    let found = 0;
    players.forEach((p,i) => { if (p.found) { btns[i].classList.add('found'); found++; } });
    document.getElementById('progressText').textContent = `ë³´ë¬¼ ë°œê²¬: ${found} / 4`;
    if (found === 4) document.getElementById('bonusBtn').classList.add('active');
}

function showBonus() {
    spawnParticles();
    document.getElementById('bonusModal').classList.add('show');
}
</script>
</body>
</html>
