<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë¶ëŒ€ ë³´ë¬¼ì°¾ê¸°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #fff; height: 100vh; overflow: hidden; }

        /* â”€â”€ ë¡œë¹„ â”€â”€ */
        #lobby {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding: 20px;
        }
        #lobby h1 {
            font-size: 3rem; margin-bottom: 10px;
            background: linear-gradient(135deg, #f5af19, #f12711);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #lobby .subtitle { color: #888; margin-bottom: 40px; font-size: 1.1rem; }
        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 500px; width: 100%; }
        .player-btn {
            position: relative; padding: 30px 20px; border: none; border-radius: 16px;
            font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer;
            transition: all 0.3s; overflow: hidden;
        }
        .player-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .player-btn.found { opacity: 0.7; }
        .player-btn.found::after {
            content: '\2705 ë°œê²¬!'; position: absolute; top: 8px; right: 12px;
            font-size: 0.8rem; background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 8px;
        }
        .player-btn .icon { font-size: 2.5rem; display: block; margin-bottom: 8px; }
        .p1 { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .p2 { background: linear-gradient(135deg, #3498db, #2980b9); }
        .p3 { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .p4 { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .bonus-section { margin-top: 40px; text-align: center; }
        .bonus-btn {
            padding: 18px 50px; border: none; border-radius: 50px;
            font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer;
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            transition: all 0.3s; opacity: 0.3; pointer-events: none;
        }
        .bonus-btn.active { opacity: 1; pointer-events: auto; animation: glow 1.5s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 10px #8e44ad; } to { box-shadow: 0 0 30px #8e44ad, 0 0 60px #9b59b6; } }
        .progress-text { margin-top: 15px; color: #aaa; font-size: 0.95rem; }

        /* â”€â”€ ê²Œì„ í™”ë©´ â”€â”€ */
        #gameView { display: none; height: 100vh; flex-direction: column; }
        #gameView.active { display: flex; }

        /* ìƒë‹¨ í—¤ë” */
        .game-header {
            background: #1a1a2e; padding: 8px 16px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0; z-index: 10;
        }
        .game-header h2 { font-size: 1rem; }
        .back-btn {
            padding: 5px 14px; border: 2px solid #fff; border-radius: 20px;
            background: transparent; color: #fff; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
        }
        .back-btn:hover { background: #fff; color: #1a1a2e; }
        .header-info { display: flex; align-items: center; gap: 16px; }
        .step-counter { font-size: 0.8rem; color: #aaa; }
        .step-counter span { color: #f5af19; font-weight: bold; }

        /* 1ì¸ì¹­ ë·° ì˜ì—­ */
        .fpv-container {
            position: relative; flex: 1; min-height: 0;
            background: #0a0a1a; overflow: hidden;
        }
        #fpvCanvas { width: 100%; height: 100%; display: block; }
        .fpv-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 5;
        }

        /* ì‹¬ë°• í…Œë‘ë¦¬ */
        .fpv-heartbeat {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 6;
            border: 4px solid transparent; transition: border-color 0.3s;
        }
        .fpv-heartbeat.warm { animation: hbWarm 1s ease-in-out infinite; }
        .fpv-heartbeat.hot { animation: hbHot 0.5s ease-in-out infinite; }
        @keyframes hbWarm { 0%,100% { border-color: transparent; } 50% { border-color: rgba(245,175,25,0.5); } }
        @keyframes hbHot { 0%,100% { border-color: transparent; } 50% { border-color: rgba(231,76,60,0.7); } }

        /* ë³´ë¬¼ ë°œê²¬ ë¹› */
        .fpv-glow {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            width: 300px; height: 300px; border-radius: 50%; pointer-events: none; z-index: 7;
            background: radial-gradient(circle, rgba(245,175,25,0.5) 0%, transparent 70%);
            animation: pulseGlow 1s ease-in-out infinite alternate;
            display: none;
        }
        @keyframes pulseGlow { 0% { transform: translate(-50%,-50%) scale(0.8); opacity: 0.5; } 100% { transform: translate(-50%,-50%) scale(1.3); opacity: 1; } }

        /* ê±°ë¦¬ í…ìŠ¤íŠ¸ (1ì¸ì¹­ ë·° ìœ„) */
        .fpv-distance {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            z-index: 8; text-align: center; pointer-events: none;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            padding: 8px 20px; border-radius: 20px; font-size: 1.1rem; font-weight: bold;
            white-space: nowrap;
        }

        /* êµ¬ë¶„ì„  */
        .divider {
            height: 4px; background: #f5af19; flex-shrink: 0;
        }

        /* í•˜ë‹¨: ì§€ë„ + HUD */
        .map-section {
            position: relative; height: 35vh; flex-shrink: 0;
        }
        #map { width: 100%; height: 100%; }

        /* ê±·ê¸° ì¸ë””ì¼€ì´í„° */
        .walking-indicator {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: none; align-items: center; gap: 6px; pointer-events: none;
            background: rgba(26,26,46,0.9); backdrop-filter: blur(8px);
            padding: 6px 14px; border-radius: 16px; font-size: 0.8rem;
        }
        .walking-indicator.show { display: flex; }
        .walk-dots span {
            display: inline-block; width: 5px; height: 5px; background: #f5af19;
            border-radius: 50%; margin: 0 1px; animation: walkDot 0.6s ease infinite;
        }
        .walk-dots span:nth-child(2) { animation-delay: 0.15s; }
        .walk-dots span:nth-child(3) { animation-delay: 0.3s; }
        @keyframes walkDot { 0%,100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } }

        /* HUD ì˜¤ë²„ë ˆì´ (ì§€ë„ ìœ„) */
        .map-hud {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(26,26,46,0.9); backdrop-filter: blur(8px);
            padding: 10px 16px; pointer-events: none;
        }
        .hud-row { display: flex; align-items: center; justify-content: space-between; }
        .hud-left .hint-text { font-size: 0.75rem; color: #aaa; }
        .compass {
            width: 44px; height: 44px; position: relative;
            border: 2px solid rgba(255,255,255,0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .compass-arrow {
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 18px solid #e74c3c; transition: transform 0.5s ease; position: absolute;
        }
        .compass-n { position: absolute; top: 2px; font-size: 0.55rem; color: #e74c3c; font-weight: bold; }
        .distance-bar-wrap { margin-top: 6px; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .distance-bar { height: 100%; border-radius: 3px; transition: width 0.8s ease, background 0.5s; width: 0%; }

        /* í™”ë©´ í”ë“¤ë¦¼ */
        @keyframes shake {
            0%,100%{transform:translate(0)} 10%{transform:translate(-3px,-2px)} 20%{transform:translate(3px,2px)}
            30%{transform:translate(-2px,3px)} 40%{transform:translate(2px,-3px)} 50%{transform:translate(-3px,1px)}
        }
        .screen-shake { animation: shake 0.4s ease; }

        /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #16213e; border-radius: 20px; padding: 40px;
            text-align: center; max-width: 400px; width: 90%;
            animation: popIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
        }
        @keyframes popIn { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }
        .modal .treasure-icon { font-size: 5rem; margin-bottom: 15px; }
        .modal h2 { font-size: 1.8rem; margin-bottom: 10px; color: #f5af19; }
        .modal p { color: #aaa; margin-bottom: 20px; white-space: pre-line; }
        .modal button {
            padding: 12px 40px; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #f5af19, #f12711);
            color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }
        .bonus-modal h2 { color: #9b59b6; }
        .coupon {
            background: linear-gradient(135deg, #f5af19, #f12711);
            border-radius: 12px; padding: 20px; margin: 15px 0; font-size: 1.5rem; font-weight: bold;
        }
        .coupon .label { font-size: 0.85rem; opacity: 0.8; }

        /* íŒŒí‹°í´ */
        .particle {
            position: fixed; pointer-events: none; z-index: 3000;
            font-size: 1.5rem; animation: fall 2s ease-in forwards;
        }
        @keyframes fall { 0%{opacity:1;transform:translateY(0) rotate(0)} 100%{opacity:0;transform:translateY(100vh) rotate(720deg)} }

        .temp-hot { color: #e74c3c; }
        .temp-warm { color: #f39c12; }
        .temp-cool { color: #3498db; }
        .temp-cold { color: #2980b9; }
    </style>
</head>
<body>

<!-- ====== ë¡œë¹„ ====== -->
<div id="lobby">
    <h1>ğŸ—ºï¸ ë³´ë¬¼ì°¾ê¸°</h1>
    <p class="subtitle">ê²½ë¶ëŒ€í•™êµ ìº í¼ìŠ¤ - ìˆ¨ê²¨ì§„ ë³´ë¬¼ì„ ì°¾ì•„ë¼!</p>
    <div class="player-grid">
        <button class="player-btn p1" onclick="startGame(1)"><span class="icon">ğŸ”´</span>í”Œë ˆì´ì–´ 1</button>
        <button class="player-btn p2" onclick="startGame(2)"><span class="icon">ğŸ”µ</span>í”Œë ˆì´ì–´ 2</button>
        <button class="player-btn p3" onclick="startGame(3)"><span class="icon">ğŸŸ¢</span>í”Œë ˆì´ì–´ 3</button>
        <button class="player-btn p4" onclick="startGame(4)"><span class="icon">ğŸŸ¡</span>í”Œë ˆì´ì–´ 4</button>
    </div>
    <div class="bonus-section">
        <button class="bonus-btn" id="bonusBtn" onclick="showBonus()">ğŸ ë³´ë„ˆìŠ¤ ì„œë¹„ìŠ¤ ë°›ê¸°</button>
        <p class="progress-text" id="progressText">ë³´ë¬¼ ë°œê²¬: 0 / 4</p>
    </div>
</div>

<!-- ====== ê²Œì„ í™”ë©´ ====== -->
<div id="gameView">
    <!-- í—¤ë” -->
    <div class="game-header">
        <button class="back-btn" onclick="goBack()">â† ë¡œë¹„</button>
        <h2 id="mapTitle">í”Œë ˆì´ì–´ 1</h2>
        <div class="header-info">
            <div class="step-counter">ğŸ‘£ <span id="stepCount">0</span></div>
        </div>
    </div>

    <!-- 1ì¸ì¹­ ë·° (ìƒë‹¨) -->
    <div class="fpv-container" id="fpvContainer">
        <canvas id="fpvCanvas"></canvas>
        <div class="fpv-heartbeat" id="fpvHeartbeat"></div>
        <div class="fpv-glow" id="fpvGlow"></div>
        <div class="fpv-distance" id="fpvDistance">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ íƒí—˜ì„ ì‹œì‘í•˜ì„¸ìš”</div>
    </div>

    <!-- êµ¬ë¶„ì„  -->
    <div class="divider"></div>

    <!-- ì§€ë„ (í•˜ë‹¨) -->
    <div class="map-section" id="mapSection">
        <div id="map"></div>
        <div class="walking-indicator" id="walkingIndicator">
            <div class="walk-dots"><span></span><span></span><span></span></div>
            <span>ì´ë™ ì¤‘...</span>
        </div>
        <div class="map-hud">
            <div class="hud-row">
                <div class="hud-left">
                    <div class="hint-text" id="hintText">í´ë¦­í•œ ìœ„ì¹˜ë¡œ ê±¸ì–´ê°‘ë‹ˆë‹¤</div>
                </div>
                <div class="compass">
                    <span class="compass-n">N</span>
                    <div class="compass-arrow" id="compassArrow"></div>
                </div>
            </div>
            <div class="distance-bar-wrap">
                <div class="distance-bar" id="distanceBar"></div>
            </div>
        </div>
    </div>
</div>

<!-- ====== ëª¨ë‹¬ ====== -->
<div class="modal-overlay" id="foundModal">
    <div class="modal">
        <div class="treasure-icon">ğŸ‰</div>
        <h2>ë³´ë¬¼ ë°œê²¬!</h2>
        <p id="foundMsg">ì¶•í•˜í•©ë‹ˆë‹¤!</p>
        <button onclick="closeFoundModal()">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>
<div class="modal-overlay" id="bonusModal">
    <div class="modal bonus-modal">
        <div class="treasure-icon">ğŸ†ğŸŠğŸ†</div>
        <h2>ì „ì› ë³´ë¬¼ ë°œê²¬!</h2>
        <p>4ëª… ëª¨ë‘ ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤! íŠ¹ë³„ ë³´ë„ˆìŠ¤ë¥¼ ë“œë¦½ë‹ˆë‹¤!</p>
        <div class="coupon"><div class="label">íŠ¹ë³„ í• ì¸ ì¿ í°</div>ğŸ« 50% OFF</div>
        <p style="font-size:0.85rem;">ì¿ í°ì½”ë“œ: KNU-TREASURE-2026</p>
        <button onclick="closeBonusModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìƒìˆ˜ & ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAMPUS_CENTER = [35.8882, 128.6107];
const CAMPUS_BOUNDS = { latMin: 35.884, latMax: 35.893, lngMin: 128.605, lngMax: 128.617 };
const FIND_RADIUS = 50;
const WALK_SPEED = 15;
const STEP_INTERVAL = 60;

const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
const playerNames = ['í”Œë ˆì´ì–´ 1', 'í”Œë ˆì´ì–´ 2', 'í”Œë ˆì´ì–´ 3', 'í”Œë ˆì´ì–´ 4'];
const treasureEmojis = ['ğŸ’', 'ğŸ‘‘', 'ğŸº', 'â­'];

let players = Array.from({length: 4}, () => ({ found: false, treasure: null }));
let currentPlayer = null;

// Leaflet
let map = null;
let playerMarker = null;
let treasureMarker = null;
let radiusCircle = null;
let hintCircle = null;
let pathLine = null;
let footprints = [];

// ê±·ê¸°
let playerPos = null;
let walkAnimation = null;
let isWalking = false;
let stepCount = 0;
let lastBearing = 0;

// 1ì¸ì¹­ ë·° (ìº”ë²„ìŠ¤)
let fpvCanvas = null;
let fpvCtx = null;
let fpvAnimFrame = null;
let fpvTime = 0;
let fpvWalking = false;
let fpvBearing = 0;
let fpvDistance = 9999;
let fpvFound = false;
// ì§€í˜• ìš”ì†Œ (ë‚˜ë¬´, ê±´ë¬¼ ë“±)
let fpvObjects = [];

// ë³´ë¬¼ ìœ„ì¹˜ ì´ˆê¸°í™”
initTreasures();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìœ í‹¸ë¦¬í‹°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000, dLat = (lat2-lat1)*Math.PI/180, dLng = (lng2-lng1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function getBearing(lat1, lng1, lat2, lng2) {
    const dLng = (lng2-lng1)*Math.PI/180;
    const y = Math.sin(dLng)*Math.cos(lat2*Math.PI/180);
    const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
              Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLng);
    return (Math.atan2(y,x)*180/Math.PI + 360) % 360;
}

function lerpLatLng(a, b, t) { return [a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t]; }

function randomCampusLocation() {
    return [
        CAMPUS_BOUNDS.latMin + Math.random()*(CAMPUS_BOUNDS.latMax - CAMPUS_BOUNDS.latMin),
        CAMPUS_BOUNDS.lngMin + Math.random()*(CAMPUS_BOUNDS.lngMax - CAMPUS_BOUNDS.lngMin)
    ];
}

function initTreasures() {
    for (let i = 0; i < 4; i++) players[i].treasure = randomCampusLocation();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  1ì¸ì¹­ ë·° (ìº”ë²„ìŠ¤ ë Œë”ë§)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFPV() {
    fpvCanvas = document.getElementById('fpvCanvas');
    fpvCtx = fpvCanvas.getContext('2d');
    fpvTime = 0;
    fpvWalking = false;
    fpvFound = false;
    fpvDistance = 9999;

    // ëœë¤ ì§€í˜• ê°ì²´ ìƒì„± (ë‚˜ë¬´, ê±´ë¬¼, ê°€ë¡œë“±)
    fpvObjects = [];
    for (let i = 0; i < 40; i++) {
        fpvObjects.push({
            type: ['tree', 'building', 'lamp', 'bush'][Math.floor(Math.random()*4)],
            x: (Math.random() - 0.5) * 2000,   // -1000 ~ 1000
            z: 100 + Math.random() * 800,       // ê¹Šì´
            baseZ: 100 + Math.random() * 800,
            color: `hsl(${Math.random()*60 + 100}, ${40+Math.random()*30}%, ${25+Math.random()*20}%)`,
            height: 30 + Math.random() * 80,
            width: 15 + Math.random() * 40,
        });
    }

    resizeFPV();
    window.addEventListener('resize', resizeFPV);
    renderFPV();
}

function resizeFPV() {
    if (!fpvCanvas) return;
    const container = document.getElementById('fpvContainer');
    fpvCanvas.width = container.clientWidth * window.devicePixelRatio;
    fpvCanvas.height = container.clientHeight * window.devicePixelRatio;
    fpvCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
}

function renderFPV() {
    if (!fpvCanvas) return;
    const W = fpvCanvas.width / window.devicePixelRatio;
    const H = fpvCanvas.height / window.devicePixelRatio;
    const ctx = fpvCtx;

    ctx.clearRect(0, 0, W, H);
    fpvTime += 0.016;

    // ê±¸ì„ ë•Œ í™”ë©´ í”ë“¤ë¦¼
    let shakeX = 0, shakeY = 0;
    if (fpvWalking) {
        shakeX = Math.sin(fpvTime * 8) * 3;
        shakeY = Math.abs(Math.sin(fpvTime * 16)) * 4;
    }

    ctx.save();
    ctx.translate(shakeX, shakeY);

    // â”€â”€ í•˜ëŠ˜ (ê·¸ë¼ë°ì´ì…˜) â”€â”€
    const horizonY = H * 0.42;
    const skyGrad = ctx.createLinearGradient(0, 0, 0, horizonY);
    if (fpvDistance < 100) {
        // ê°€ê¹Œìš°ë©´ í•˜ëŠ˜ì´ ë¶‰ì–´ì§
        const intensity = Math.max(0, 1 - fpvDistance / 100);
        skyGrad.addColorStop(0, `rgba(${30 + intensity*100}, ${10 + intensity*20}, ${60 - intensity*40}, 1)`);
        skyGrad.addColorStop(1, `rgba(${40 + intensity*120}, ${30 + intensity*60}, ${80 - intensity*50}, 1)`);
    } else {
        skyGrad.addColorStop(0, '#0a0a2e');
        skyGrad.addColorStop(1, '#1a1a4e');
    }
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, W, horizonY);

    // â”€â”€ ë³„ â”€â”€
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    for (let i = 0; i < 50; i++) {
        const sx = (i * 137.5 + fpvTime * 2) % W;
        const sy = (i * 89.3) % (horizonY - 20);
        const brightness = 0.3 + 0.7 * Math.sin(fpvTime * 2 + i);
        ctx.globalAlpha = brightness * 0.6;
        ctx.fillRect(sx, sy, 1.5, 1.5);
    }
    ctx.globalAlpha = 1;

    // â”€â”€ ë‹¬ â”€â”€
    const moonX = W * 0.8;
    const moonY = H * 0.12;
    ctx.beginPath();
    ctx.arc(moonX, moonY, 25, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(240,240,200,0.15)';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(moonX, moonY, 15, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(240,240,200,0.9)';
    ctx.fill();

    // â”€â”€ ë•… (ì›ê·¼ê° ìˆëŠ” ê²©ì) â”€â”€
    const groundGrad = ctx.createLinearGradient(0, horizonY, 0, H);
    groundGrad.addColorStop(0, '#1a2a1a');
    groundGrad.addColorStop(1, '#0d1a0d');
    ctx.fillStyle = groundGrad;
    ctx.fillRect(0, horizonY, W, H - horizonY);

    // ê²©ì ë¼ì¸ (ì›ê·¼ íˆ¬ì‹œ)
    const vanishX = W / 2;
    const vanishY = horizonY;
    ctx.strokeStyle = 'rgba(100,160,100,0.15)';
    ctx.lineWidth = 1;

    // ë°©ì‚¬í˜• ë¼ì¸
    for (let i = -8; i <= 8; i++) {
        const endX = vanishX + i * W * 0.15;
        ctx.beginPath();
        ctx.moveTo(vanishX, vanishY);
        ctx.lineTo(endX, H);
        ctx.stroke();
    }

    // ìˆ˜í‰ ë¼ì¸ (ê¹Šì´ê°)
    for (let i = 1; i <= 12; i++) {
        const t = i / 12;
        const y = vanishY + (H - vanishY) * (t * t); // ë¹„ì„ í˜• ê¹Šì´ê°
        ctx.globalAlpha = 0.08 + t * 0.12;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(W, y);
        ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // â”€â”€ ê¸¸ (ì¤‘ì•™ ë„ë¡œ) â”€â”€
    ctx.beginPath();
    ctx.moveTo(vanishX - 2, vanishY);
    ctx.lineTo(vanishX - W * 0.18, H);
    ctx.lineTo(vanishX + W * 0.18, H);
    ctx.lineTo(vanishX + 2, vanishY);
    ctx.closePath();
    ctx.fillStyle = 'rgba(60,60,70,0.6)';
    ctx.fill();

    // ë„ë¡œ ì¤‘ì•™ì„  (ì ì„ )
    ctx.strokeStyle = 'rgba(245,175,25,0.4)';
    ctx.lineWidth = 2;
    ctx.setLineDash([8, 12]);
    const lineOffset = fpvWalking ? (fpvTime * 80) % 20 : 0;
    ctx.lineDashOffset = -lineOffset;
    ctx.beginPath();
    ctx.moveTo(vanishX, vanishY + 10);
    ctx.lineTo(vanishX, H);
    ctx.stroke();
    ctx.setLineDash([]);

    // â”€â”€ ì§€í˜• ê°ì²´ ë Œë”ë§ â”€â”€
    // ê¹Šì´ ì •ë ¬ (ë¨¼ ê²ƒë¶€í„°)
    const sortedObjs = [...fpvObjects].sort((a, b) => b.z - a.z);
    for (const obj of sortedObjs) {
        // ê±¸ì„ ë•Œ ê°ì²´ê°€ ë‹¤ê°€ì˜¤ëŠ” íš¨ê³¼
        if (fpvWalking) {
            obj.z -= 2;
            if (obj.z < 20) obj.z = obj.baseZ + 400;
        }

        const perspective = 300 / (obj.z + 100);
        const screenX = vanishX + obj.x * perspective;
        const screenY = vanishY + (H - vanishY) * perspective * 1.2;
        const scale = perspective * 2;

        if (screenX < -100 || screenX > W + 100 || screenY < vanishY) continue;

        ctx.globalAlpha = Math.min(1, perspective * 3);

        if (obj.type === 'tree') {
            // ë‚˜ë¬´ ì¤„ê¸°
            ctx.fillStyle = '#3a2a1a';
            ctx.fillRect(screenX - 3*scale, screenY - obj.height*scale*0.5, 6*scale, obj.height*scale*0.5);
            // ë‚˜ë¬´ ì
            ctx.beginPath();
            ctx.arc(screenX, screenY - obj.height*scale*0.6, obj.width*scale*0.4, 0, Math.PI*2);
            ctx.fillStyle = obj.color;
            ctx.fill();
        } else if (obj.type === 'building') {
            ctx.fillStyle = 'rgba(50,50,70,0.8)';
            const bw = obj.width * scale;
            const bh = obj.height * scale;
            ctx.fillRect(screenX - bw/2, screenY - bh, bw, bh);
            // ì°½ë¬¸
            ctx.fillStyle = 'rgba(255,220,100,0.3)';
            for (let wy = 0; wy < 3; wy++) {
                for (let wx = 0; wx < 2; wx++) {
                    ctx.fillRect(
                        screenX - bw/2 + bw*0.15 + wx*bw*0.45,
                        screenY - bh + bh*0.15 + wy*bh*0.3,
                        bw*0.2, bh*0.15
                    );
                }
            }
        } else if (obj.type === 'lamp') {
            ctx.fillStyle = '#555';
            ctx.fillRect(screenX - 1.5*scale, screenY - 50*scale, 3*scale, 50*scale);
            // ê°€ë¡œë“± ë¹›
            ctx.beginPath();
            ctx.arc(screenX, screenY - 50*scale, 8*scale, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(255,220,100,0.2)';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(screenX, screenY - 50*scale, 3*scale, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(255,240,180,0.8)';
            ctx.fill();
        } else if (obj.type === 'bush') {
            ctx.beginPath();
            ctx.arc(screenX, screenY - 5*scale, obj.width*scale*0.3, 0, Math.PI*2);
            ctx.fillStyle = obj.color;
            ctx.fill();
        }
    }
    ctx.globalAlpha = 1;

    // â”€â”€ ë³´ë¬¼ í‘œì‹œ (ê°€ê¹Œìš¸ ë•Œ) â”€â”€
    if (fpvDistance < 200 && !fpvFound) {
        const treasureScale = Math.max(0.3, 1 - fpvDistance / 200);
        const treasureY = horizonY + (H - horizonY) * 0.3;
        const pulse = 1 + Math.sin(fpvTime * 4) * 0.15;

        // ë³´ë¬¼ ë¹›
        const glowRadius = 40 * treasureScale * pulse;
        const glowGrad = ctx.createRadialGradient(vanishX, treasureY, 0, vanishX, treasureY, glowRadius);
        glowGrad.addColorStop(0, `rgba(245,175,25,${0.6 * treasureScale})`);
        glowGrad.addColorStop(0.5, `rgba(241,39,17,${0.3 * treasureScale})`);
        glowGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = glowGrad;
        ctx.beginPath();
        ctx.arc(vanishX, treasureY, glowRadius, 0, Math.PI*2);
        ctx.fill();

        // ë³´ë¬¼ ì´ëª¨ì§€
        if (fpvDistance < 100) {
            const emojiSize = 20 + 30 * treasureScale;
            ctx.font = `${emojiSize}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(currentPlayer !== null ? treasureEmojis[currentPlayer] : 'ğŸ’', vanishX, treasureY);
        }

        // ë¬¼ìŒí‘œ (ë©€ ë•Œ)
        if (fpvDistance >= 100 && fpvDistance < 200) {
            ctx.font = `${16 * treasureScale + 10}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillStyle = `rgba(245,175,25,${0.5 + Math.sin(fpvTime*3)*0.3})`;
            ctx.fillText('?', vanishX, treasureY);
        }
    }

    // â”€â”€ ë ˆì´ë” (ìš°ì¸¡ ìƒë‹¨) â”€â”€
    const radarR = Math.min(55, W * 0.1);
    const radarX = W - radarR - 16;
    const radarY = radarR + 16;

    // ë ˆì´ë” ë°°ê²½
    ctx.beginPath();
    ctx.arc(radarX, radarY, radarR, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(0,20,0,0.7)';
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,255,0,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // ë ˆì´ë” ì›
    for (let r = 1; r <= 3; r++) {
        ctx.beginPath();
        ctx.arc(radarX, radarY, radarR * r / 3, 0, Math.PI*2);
        ctx.strokeStyle = 'rgba(0,255,0,0.15)';
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    // ì‹­ìì„ 
    ctx.strokeStyle = 'rgba(0,255,0,0.15)';
    ctx.beginPath();
    ctx.moveTo(radarX - radarR, radarY);
    ctx.lineTo(radarX + radarR, radarY);
    ctx.moveTo(radarX, radarY - radarR);
    ctx.lineTo(radarX, radarY + radarR);
    ctx.stroke();

    // ë ˆì´ë” ìŠ¤ìœ•
    const sweepAngle = fpvTime * 2;
    ctx.beginPath();
    ctx.moveTo(radarX, radarY);
    ctx.arc(radarX, radarY, radarR, sweepAngle, sweepAngle + 0.5);
    ctx.closePath();
    const sweepGrad = ctx.createRadialGradient(radarX, radarY, 0, radarX, radarY, radarR);
    sweepGrad.addColorStop(0, 'rgba(0,255,0,0.3)');
    sweepGrad.addColorStop(1, 'rgba(0,255,0,0.05)');
    ctx.fillStyle = sweepGrad;
    ctx.fill();

    // í”Œë ˆì´ì–´ ìœ„ì¹˜ (ì¤‘ì•™)
    ctx.beginPath();
    ctx.arc(radarX, radarY, 3, 0, Math.PI*2);
    ctx.fillStyle = currentPlayer !== null ? playerColors[currentPlayer] : '#fff';
    ctx.fill();

    // ë³´ë¬¼ ìœ„ì¹˜ (ë ˆì´ë”ì—)
    if (playerPos && currentPlayer !== null) {
        const treasure = players[currentPlayer].treasure;
        const bearingRad = fpvBearing * Math.PI / 180;
        const distNorm = Math.min(1, fpvDistance / 500);
        const dotX = radarX + Math.sin(bearingRad) * radarR * distNorm;
        const dotY = radarY - Math.cos(bearingRad) * radarR * distNorm;

        // ë³´ë¬¼ ì  ê¹œë¹¡ì„
        const blink = 0.5 + 0.5 * Math.sin(fpvTime * 6);
        ctx.beginPath();
        ctx.arc(dotX, dotY, 4, 0, Math.PI*2);
        ctx.fillStyle = `rgba(245,175,25,${blink})`;
        ctx.fill();

        // ê±°ë¦¬ ê°€ê¹Œìš°ë©´ ë” í° ì 
        if (fpvDistance < 100) {
            ctx.beginPath();
            ctx.arc(dotX, dotY, 8, 0, Math.PI*2);
            ctx.fillStyle = `rgba(245,175,25,${blink * 0.3})`;
            ctx.fill();
        }
    }

    // ë ˆì´ë” í…ìŠ¤íŠ¸
    ctx.font = '9px monospace';
    ctx.fillStyle = 'rgba(0,255,0,0.6)';
    ctx.textAlign = 'center';
    ctx.fillText('RADAR', radarX, radarY + radarR + 12);

    // â”€â”€ ë°©í–¥ ì§€ì‹œ í™”ì‚´í‘œ (ìƒë‹¨ ì¤‘ì•™) â”€â”€
    if (playerPos && currentPlayer !== null && !fpvFound) {
        const arrowSize = 20;
        const arrowY2 = 30;
        ctx.save();
        ctx.translate(vanishX, arrowY2);
        ctx.rotate(fpvBearing * Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(0, -arrowSize);
        ctx.lineTo(-arrowSize * 0.6, arrowSize * 0.4);
        ctx.lineTo(0, arrowSize * 0.1);
        ctx.lineTo(arrowSize * 0.6, arrowSize * 0.4);
        ctx.closePath();

        const arrowColor = fpvDistance < 100 ? '#e74c3c' :
                          fpvDistance < 200 ? '#f39c12' :
                          fpvDistance < 400 ? '#3498db' : '#2980b9';
        ctx.fillStyle = arrowColor;
        ctx.globalAlpha = 0.7 + Math.sin(fpvTime * 3) * 0.3;
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.restore();

        // "ë³´ë¬¼ ë°©í–¥" í…ìŠ¤íŠ¸
        ctx.font = '11px sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.textAlign = 'center';
        ctx.fillText('ë³´ë¬¼ ë°©í–¥ â†‘', vanishX, arrowY2 + arrowSize + 14);
    }

    // â”€â”€ ê±·ê¸° íš¨ê³¼: ë°œìêµ­ ì˜¤ë²„ë ˆì´ â”€â”€
    if (fpvWalking) {
        const footY = H - 40;
        const footAlpha = 0.3 + 0.2 * Math.sin(fpvTime * 8);
        ctx.font = '24px serif';
        ctx.globalAlpha = footAlpha;
        ctx.textAlign = 'center';
        if (Math.floor(fpvTime * 4) % 2 === 0) {
            ctx.fillText('ğŸ‘Ÿ', vanishX - 30, footY);
        } else {
            ctx.fillText('ğŸ‘Ÿ', vanishX + 30, footY);
        }
        ctx.globalAlpha = 1;
    }

    // â”€â”€ ì•ˆê°œ íš¨ê³¼ (ê°€ì¥ìë¦¬ ë¹„ë„¤íŠ¸) â”€â”€
    const vignetteGrad = ctx.createRadialGradient(W/2, H/2, W*0.25, W/2, H/2, W*0.6);
    vignetteGrad.addColorStop(0, 'transparent');
    vignetteGrad.addColorStop(1, 'rgba(0,0,0,0.4)');
    ctx.fillStyle = vignetteGrad;
    ctx.fillRect(0, 0, W, H);

    ctx.restore();

    fpvAnimFrame = requestAnimationFrame(renderFPV);
}

function updateFPVState(dist, bearing, walking, found) {
    fpvDistance = dist;
    fpvBearing = bearing;
    fpvWalking = walking;
    fpvFound = found;

    // ê±°ë¦¬ì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const fpvDistEl = document.getElementById('fpvDistance');
    const distStr = dist < 1000 ? Math.round(dist)+'m' : (dist/1000).toFixed(1)+'km';

    if (!playerPos) {
        fpvDistEl.textContent = 'ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ íƒí—˜ì„ ì‹œì‘í•˜ì„¸ìš”';
        fpvDistEl.style.color = '#aaa';
    } else if (dist <= FIND_RADIUS) {
        fpvDistEl.innerHTML = 'ğŸ”¥ ' + distStr + ' - ë³´ë¬¼ ë°œê²¬!';
        fpvDistEl.style.color = '#e74c3c';
    } else if (dist <= 100) {
        fpvDistEl.innerHTML = 'ğŸ”¥ ' + distStr + ' - ë§¤ìš° ëœ¨ê±°ì›Œ!';
        fpvDistEl.style.color = '#e74c3c';
    } else if (dist <= 200) {
        fpvDistEl.innerHTML = 'ğŸŒ¡ï¸ ' + distStr + ' - ëœ¨ê±°ì›Œ!';
        fpvDistEl.style.color = '#f39c12';
    } else if (dist <= 400) {
        fpvDistEl.innerHTML = 'â„ï¸ ' + distStr + ' - ì°¨ê°€ì›Œ';
        fpvDistEl.style.color = '#3498db';
    } else {
        fpvDistEl.innerHTML = 'ğŸ§Š ' + distStr + ' - ë§¤ìš° ì°¨ê°€ì›Œ!';
        fpvDistEl.style.color = '#2980b9';
    }
}

function stopFPV() {
    if (fpvAnimFrame) cancelAnimationFrame(fpvAnimFrame);
    fpvAnimFrame = null;
    fpvCanvas = null;
    fpvCtx = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(num) {
    currentPlayer = num - 1;
    if (players[currentPlayer].found) {
        alert(playerNames[currentPlayer] + 'ì€(ëŠ”) ì´ë¯¸ ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!');
        return;
    }

    stepCount = 0; playerPos = null; footprints = []; lastBearing = 0;
    document.getElementById('stepCount').textContent = '0';
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameView').classList.add('active');
    document.getElementById('mapTitle').textContent =
        playerNames[currentPlayer] + ' ' + treasureEmojis[currentPlayer];

    // 1ì¸ì¹­ ë·° ì´ˆê¸°í™”
    document.getElementById('fpvHeartbeat').className = 'fpv-heartbeat';
    document.getElementById('fpvGlow').style.display = 'none';

    initMap();
    setTimeout(initFPV, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Leaflet ì§€ë„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap() {
    if (map) map.remove();

    map = L.map('map', { zoomControl: false }).setView(CAMPUS_CENTER, 16);
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OSM', maxZoom: 19
    }).addTo(map);

    L.rectangle([
        [CAMPUS_BOUNDS.latMin, CAMPUS_BOUNDS.lngMin],
        [CAMPUS_BOUNDS.latMax, CAMPUS_BOUNDS.lngMax]
    ], { color: playerColors[currentPlayer], weight: 2, fillOpacity: 0.03, dashArray: '8 4' }).addTo(map);

    const treasure = players[currentPlayer].treasure;
    hintCircle = L.circle(treasure, {
        radius: 150, color: '#f5af19', fillColor: '#f5af19',
        fillOpacity: 0.06, weight: 1, dashArray: '4 4'
    }).addTo(map);

    pathLine = L.polyline([], {
        color: playerColors[currentPlayer], weight: 3, opacity: 0.5, dashArray: '6 8'
    }).addTo(map);

    map.on('click', onMapClick);

    document.getElementById('hintText').textContent = 'ë…¸ë€ ì ì„  ì› ì•ˆì— ë³´ë¬¼ì´ ìˆìŠµë‹ˆë‹¤!';
    document.getElementById('distanceBar').style.width = '0%';

    setTimeout(() => map.invalidateSize(), 150);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§€ë„ í´ë¦­ â†’ ê±·ê¸°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onMapClick(e) {
    const target = [e.latlng.lat, e.latlng.lng];

    // ê±·ëŠ” ì¤‘ì´ë©´ í˜„ì¬ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
    if (walkAnimation) {
        clearTimeout(walkAnimation);
        walkAnimation = null;
        isWalking = false;
        document.getElementById('walkingIndicator').classList.remove('show');
    }

    if (!playerPos) {
        playerPos = target;
        placePlayer(playerPos);
        updateGameUI();
        return;
    }

    walkTo(target);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê±·ê¸° ì• ë‹ˆë©”ì´ì…˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function walkTo(target) {
    const start = [...playerPos];
    const totalDist = getDistance(start[0], start[1], target[0], target[1]);
    const totalSteps = Math.max(1, Math.ceil(totalDist / WALK_SPEED));
    let currentStep = 0;

    const bearing = getBearing(start[0], start[1], target[0], target[1]);
    lastBearing = bearing;
    document.getElementById('compassArrow').style.transform = `rotate(${bearing}deg)`;

    isWalking = true;
    document.getElementById('walkingIndicator').classList.add('show');

    function step() {
        currentStep++;
        const t = Math.min(currentStep / totalSteps, 1);
        const eased = 1 - Math.pow(1 - t, 2);
        playerPos = lerpLatLng(start, target, eased);

        placePlayer(playerPos);
        pathLine.addLatLng(playerPos);

        stepCount++;
        document.getElementById('stepCount').textContent = stepCount;
        if (stepCount % 5 === 0) addFootprint(playerPos, bearing);

        map.setView(playerPos, map.getZoom(), { animate: false });

        updateGameUI();

        // ë³´ë¬¼ ì²´í¬
        const treasure = players[currentPlayer].treasure;
        const dist = getDistance(playerPos[0], playerPos[1], treasure[0], treasure[1]);
        if (dist <= FIND_RADIUS) {
            isWalking = false;
            document.getElementById('walkingIndicator').classList.remove('show');
            foundTreasure();
            return;
        }

        if (currentStep < totalSteps) {
            walkAnimation = setTimeout(step, STEP_INTERVAL);
        } else {
            isWalking = false;
            document.getElementById('walkingIndicator').classList.remove('show');
            walkAnimation = null;
        }
    }
    step();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í”Œë ˆì´ì–´ ë§ˆì»¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placePlayer(pos) {
    const color = playerColors[currentPlayer];
    if (playerMarker) {
        playerMarker.setLatLng(pos);
    } else {
        const icon = L.divIcon({
            html: `<div style="width:18px;height:18px;border-radius:50%;background:${color};border:3px solid #fff;box-shadow:0 0 10px ${color};"></div>
            <div style="position:absolute;top:-3px;left:-3px;width:24px;height:24px;border-radius:50%;border:2px solid ${color};opacity:0.5;animation:ping 1.5s ease-out infinite;"></div>
            <style>@keyframes ping{0%{transform:scale(1);opacity:.5}100%{transform:scale(2.5);opacity:0}}</style>`,
            iconSize: [18,18], iconAnchor: [9,9], className: ''
        });
        playerMarker = L.marker(pos, { icon, zIndexOffset: 1000 }).addTo(map);
    }
    if (radiusCircle) { radiusCircle.setLatLng(pos); }
    else { radiusCircle = L.circle(pos, { radius: FIND_RADIUS, color, fillColor: color, fillOpacity: 0.08, weight: 1 }).addTo(map); }
}

function addFootprint(pos, bearing) {
    const icon = L.divIcon({
        html: `<div style="font-size:0.6rem;opacity:0.3;transform:rotate(${bearing}deg);">ğŸ‘£</div>`,
        iconSize: [10,10], iconAnchor: [5,5], className: ''
    });
    const m = L.marker(pos, { icon, interactive: false }).addTo(map);
    footprints.push(m);
    if (footprints.length > 30) map.removeLayer(footprints.shift());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ UI (ê±°ë¦¬, íš¨ê³¼)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGameUI() {
    if (!playerPos) return;

    const treasure = players[currentPlayer].treasure;
    const dist = getDistance(playerPos[0], playerPos[1], treasure[0], treasure[1]);
    const hintEl = document.getElementById('hintText');
    const bar = document.getElementById('distanceBar');
    const fpvHb = document.getElementById('fpvHeartbeat');
    const fpvGlow = document.getElementById('fpvGlow');
    const fpvContainer = document.getElementById('fpvContainer');

    const barPct = Math.max(0, Math.min(100, (1 - dist/500)*100));
    bar.style.width = barPct + '%';

    const bearingToTreasure = getBearing(playerPos[0], playerPos[1], treasure[0], treasure[1]);
    document.getElementById('compassArrow').style.transform = `rotate(${bearingToTreasure}deg)`;

    // 1ì¸ì¹­ ë·° ìƒíƒœ ì—…ë°ì´íŠ¸
    updateFPVState(dist, bearingToTreasure, isWalking, players[currentPlayer].found);

    if (dist <= FIND_RADIUS) {
        hintEl.textContent = '';
        bar.style.background = '#e74c3c';
        fpvHb.className = 'fpv-heartbeat hot';
        fpvGlow.style.display = 'block';
        fpvContainer.classList.add('screen-shake');
        setTimeout(() => fpvContainer.classList.remove('screen-shake'), 400);
    } else if (dist <= 100) {
        hintEl.textContent = 'ê±°ì˜ ë‹¤ ì™”ì–´ìš”! ì¡°ê¸ˆë§Œ ë”!';
        bar.style.background = 'linear-gradient(90deg,#e74c3c,#f39c12)';
        fpvHb.className = 'fpv-heartbeat hot';
        fpvGlow.style.display = 'block';
        if (Math.random() > 0.7) {
            fpvContainer.classList.add('screen-shake');
            setTimeout(() => fpvContainer.classList.remove('screen-shake'), 300);
        }
    } else if (dist <= 200) {
        hintEl.textContent = 'ê°€ê¹Œì›Œì§€ê³  ìˆì–´ìš”!';
        bar.style.background = 'linear-gradient(90deg,#f39c12,#f5af19)';
        fpvHb.className = 'fpv-heartbeat warm';
        fpvGlow.style.display = 'none';
    } else if (dist <= 400) {
        hintEl.textContent = 'ì•„ì§ ë©€ì–´ìš”...';
        bar.style.background = '#3498db';
        fpvHb.className = 'fpv-heartbeat';
        fpvGlow.style.display = 'none';
    } else {
        hintEl.textContent = 'ë„ˆë¬´ ë©€ì–´ìš”! ë‹¤ë¥¸ ë°©í–¥ìœ¼ë¡œ!';
        bar.style.background = '#2980b9';
        fpvHb.className = 'fpv-heartbeat';
        fpvGlow.style.display = 'none';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³´ë¬¼ ë°œê²¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function foundTreasure() {
    const treasure = players[currentPlayer].treasure;
    fpvFound = true;

    const icon = L.divIcon({
        html: `<div style="font-size:2.5rem;animation:bounceIn .6s cubic-bezier(.175,.885,.32,1.275);">${treasureEmojis[currentPlayer]}</div>
        <style>@keyframes bounceIn{0%{transform:scale(0) rotate(-20deg);opacity:0}60%{transform:scale(1.3) rotate(10deg)}100%{transform:scale(1) rotate(0);opacity:1}}</style>`,
        iconSize: [40,40], iconAnchor: [20,20], className: ''
    });
    treasureMarker = L.marker(treasure, { icon, zIndexOffset: 2000 }).addTo(map);
    map.flyTo(treasure, 18, { duration: 1 });

    players[currentPlayer].found = true;
    spawnParticles();

    setTimeout(() => {
        document.getElementById('foundMsg').textContent =
            playerNames[currentPlayer] + 'ì´(ê°€) ' + treasureEmojis[currentPlayer] +
            ' ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!\nì´ ' + stepCount + 'ê±¸ìŒ ì´ë™!';
        document.getElementById('foundModal').classList.add('show');
    }, 1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íŒŒí‹°í´
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles() {
    const emojis = ['ğŸ‰','âœ¨','ğŸŒŸ','ğŸ’«','ğŸŠ','â­','ğŸ†'];
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const p = document.createElement('div');
            p.className = 'particle';
            p.textContent = emojis[Math.floor(Math.random()*emojis.length)];
            p.style.left = Math.random()*100+'vw';
            p.style.top = '-20px';
            p.style.animationDuration = (1.5+Math.random())+'s';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 3000);
        }, i*80);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë¡œë¹„ & ëª¨ë‹¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeFoundModal() {
    document.getElementById('foundModal').classList.remove('show');
    goBack();
}
function closeBonusModal() { document.getElementById('bonusModal').classList.remove('show'); }

function goBack() {
    if (walkAnimation) { clearTimeout(walkAnimation); walkAnimation = null; }
    isWalking = false;
    document.getElementById('gameView').classList.remove('active');
    document.getElementById('lobby').style.display = 'flex';
    if (map) { map.remove(); map = null; }
    playerMarker = null; treasureMarker = null; radiusCircle = null;
    hintCircle = null; pathLine = null; footprints = [];
    stopFPV();
    updateLobbyUI();
}

function updateLobbyUI() {
    const btns = document.querySelectorAll('.player-btn');
    let found = 0;
    players.forEach((p,i) => { if (p.found) { btns[i].classList.add('found'); found++; } });
    document.getElementById('progressText').textContent = `ë³´ë¬¼ ë°œê²¬: ${found} / 4`;
    if (found === 4) document.getElementById('bonusBtn').classList.add('active');
}

function showBonus() {
    spawnParticles();
    document.getElementById('bonusModal').classList.add('show');
}
</script>

</body>
</html>
