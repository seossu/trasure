<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë¶ëŒ€ ë³´ë¬¼ì°¾ê¸°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; overflow: hidden; }

        /* â”€â”€ ë¡œë¹„ â”€â”€ */
        #lobby {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding: 20px;
        }
        #lobby h1 {
            font-size: 3rem; margin-bottom: 10px;
            background: linear-gradient(135deg, #f5af19, #f12711);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #lobby .subtitle { color: #888; margin-bottom: 40px; font-size: 1.1rem; }
        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 500px; width: 100%; }
        .player-btn {
            position: relative; padding: 30px 20px; border: none; border-radius: 16px;
            font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer;
            transition: all 0.3; overflow: hidden;
        }
        .player-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .player-btn.found { opacity: 0.7; }
        .player-btn.found::after {
            content: '\2705 ë°œê²¬!'; position: absolute; top: 8px; right: 12px;
            font-size: 0.8rem; background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 8px;
        }
        .player-btn .icon { font-size: 2.5rem; display: block; margin-bottom: 8px; }
        .p1 { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .p2 { background: linear-gradient(135deg, #3498db, #2980b9); }
        .p3 { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .p4 { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .bonus-section { margin-top: 40px; text-align: center; }
        .bonus-btn {
            padding: 18px 50px; border: none; border-radius: 50px;
            font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer;
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            transition: all 0.3s; opacity: 0.3; pointer-events: none;
        }
        .bonus-btn.active { opacity: 1; pointer-events: auto; animation: glow 1.5s ease-in-out infinite alternate; }
        .bonus-btn.active:hover { transform: scale(1.05); }
        @keyframes glow { from { box-shadow: 0 0 10px #8e44ad; } to { box-shadow: 0 0 30px #8e44ad, 0 0 60px #9b59b6; } }
        .progress-text { margin-top: 15px; color: #aaa; font-size: 0.95rem; }

        /* â”€â”€ ê²Œì„ í™”ë©´ â”€â”€ */
        #gameView { display: none; height: 100vh; position: relative; }

        /* ìƒë‹¨ ë°” */
        .game-header {
            position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(26,26,46,0.92); backdrop-filter: blur(10px);
            padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
        }
        .game-header h2 { font-size: 1.1rem; }
        .back-btn {
            padding: 6px 16px; border: 2px solid #fff; border-radius: 20px;
            background: transparent; color: #fff; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
        }
        .back-btn:hover { background: #fff; color: #1a1a2e; }
        .step-counter {
            font-size: 0.85rem; color: #aaa;
        }
        .step-counter span { color: #f5af19; font-weight: bold; }

        /* ì§€ë„ ì˜ì—­ */
        #map { width: 100%; height: 100%; }

        /* ì•ˆê°œ ì˜¤ë²„ë ˆì´ (ë¹„ë„¤íŒ…) */
        .fog-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 800;
            background: radial-gradient(circle at center, transparent 20%, rgba(26,26,46,0.3) 50%, rgba(26,26,46,0.7) 80%);
            transition: background 0.5s;
        }
        .fog-overlay.close {
            background: radial-gradient(circle at center, transparent 35%, rgba(26,26,46,0.2) 60%, rgba(26,26,46,0.5) 85%);
        }
        .fog-overlay.very-close {
            background: radial-gradient(circle at center, transparent 50%, rgba(245,175,25,0.1) 70%, rgba(26,26,46,0.3) 90%);
        }

        /* í•˜ë‹¨ HUD */
        .hud {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(26,26,46,0.92); backdrop-filter: blur(10px);
            padding: 14px 20px;
        }
        .hud-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .hud .distance-text { font-size: 1.3rem; font-weight: bold; }
        .hud .hint-text { font-size: 0.85rem; color: #aaa; }
        .compass {
            width: 50px; height: 50px; position: relative;
            border: 2px solid rgba(255,255,255,0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .compass-arrow {
            width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-bottom: 20px solid #e74c3c; transition: transform 0.5s ease;
            position: absolute;
        }
        .compass-n { position: absolute; top: 2px; font-size: 0.6rem; color: #e74c3c; font-weight: bold; }

        /* ê±°ë¦¬ ë°” */
        .distance-bar-container {
            width: 100%; height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden;
        }
        .distance-bar {
            height: 100%; border-radius: 4px; transition: width 0.8s ease, background 0.5s;
            width: 0%;
        }

        /* ê±·ê¸° ì¸ë””ì¼€ì´í„° */
        .walking-indicator {
            position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: none; align-items: center; gap: 8px;
            background: rgba(26,26,46,0.85); backdrop-filter: blur(8px);
            padding: 8px 18px; border-radius: 20px; font-size: 0.9rem;
        }
        .walking-indicator.show { display: flex; }
        .walk-dots span {
            display: inline-block; width: 6px; height: 6px; background: #f5af19;
            border-radius: 50%; margin: 0 2px; animation: walkDot 0.6s ease infinite;
        }
        .walk-dots span:nth-child(2) { animation-delay: 0.15s; }
        .walk-dots span:nth-child(3) { animation-delay: 0.3s; }
        @keyframes walkDot {
            0%, 100% { opacity: 0.3; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }

        /* ë°œìêµ­ */
        .footprint {
            position: absolute; z-index: 600; pointer-events: none;
            font-size: 0.9rem; opacity: 0.6;
            animation: fadeFootprint 3s ease forwards;
        }
        @keyframes fadeFootprint {
            0% { opacity: 0.6; }
            100% { opacity: 0; }
        }

        /* í™”ë©´ í”ë“¤ë¦¼ */
        @keyframes shake {
            0%, 100% { transform: translate(0); }
            10% { transform: translate(-3px, -2px); }
            20% { transform: translate(3px, 2px); }
            30% { transform: translate(-2px, 3px); }
            40% { transform: translate(2px, -3px); }
            50% { transform: translate(-3px, 1px); }
            60% { transform: translate(3px, -1px); }
            70% { transform: translate(-1px, 3px); }
            80% { transform: translate(1px, -2px); }
            90% { transform: translate(-2px, 2px); }
        }
        .screen-shake { animation: shake 0.5s ease; }

        /* ë³´ë¬¼ ë°œê²¬ ë¹› */
        .treasure-glow {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; border-radius: 50%; pointer-events: none; z-index: 900;
            background: radial-gradient(circle, rgba(245,175,25,0.4) 0%, transparent 70%);
            animation: pulseGlow 1s ease-in-out infinite alternate;
            display: none;
        }
        @keyframes pulseGlow {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
        }

        /* ì‹¬ë°• íš¨ê³¼ (ê·¼ì ‘ ì‹œ í™”ë©´ í…Œë‘ë¦¬) */
        .heartbeat-border {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 850;
            border: 4px solid transparent; transition: border-color 0.3s;
        }
        .heartbeat-border.active {
            animation: heartbeatBorder 1s ease-in-out infinite;
        }
        @keyframes heartbeatBorder {
            0%, 100% { border-color: transparent; }
            50% { border-color: rgba(245,175,25,0.6); }
        }
        .heartbeat-border.very-close {
            animation: heartbeatBorderFast 0.5s ease-in-out infinite;
        }
        @keyframes heartbeatBorderFast {
            0%, 100% { border-color: transparent; }
            50% { border-color: rgba(231,76,60,0.8); }
        }

        /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #16213e; border-radius: 20px; padding: 40px;
            text-align: center; max-width: 400px; width: 90%;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal .treasure-icon { font-size: 5rem; margin-bottom: 15px; }
        .modal h2 { font-size: 1.8rem; margin-bottom: 10px; color: #f5af19; }
        .modal p { color: #aaa; margin-bottom: 20px; }
        .modal button {
            padding: 12px 40px; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #f5af19, #f12711);
            color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .modal button:hover { transform: scale(1.05); }
        .bonus-modal .treasure-icon { font-size: 4rem; }
        .bonus-modal h2 { color: #9b59b6; }
        .coupon {
            background: linear-gradient(135deg, #f5af19, #f12711);
            border-radius: 12px; padding: 20px; margin: 15px 0;
            font-size: 1.5rem; font-weight: bold;
        }
        .coupon .label { font-size: 0.85rem; opacity: 0.8; }

        /* â”€â”€ íŒŒí‹°í´ â”€â”€ */
        .particle {
            position: fixed; pointer-events: none; z-index: 3000;
            font-size: 1.5rem; animation: fall 2s ease-in forwards;
        }
        @keyframes fall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
        }

        .temp-hot { color: #e74c3c; }
        .temp-warm { color: #f39c12; }
        .temp-cool { color: #3498db; }
        .temp-cold { color: #2980b9; }
    </style>
</head>
<body>

<!-- ====== ë¡œë¹„ ====== -->
<div id="lobby">
    <h1>ğŸ—ºï¸ ë³´ë¬¼ì°¾ê¸°</h1>
    <p class="subtitle">ê²½ë¶ëŒ€í•™êµ ìº í¼ìŠ¤ - ìˆ¨ê²¨ì§„ ë³´ë¬¼ì„ ì°¾ì•„ë¼!</p>
    <div class="player-grid">
        <button class="player-btn p1" onclick="startGame(1)"><span class="icon">ğŸ”´</span>í”Œë ˆì´ì–´ 1</button>
        <button class="player-btn p2" onclick="startGame(2)"><span class="icon">ğŸ”µ</span>í”Œë ˆì´ì–´ 2</button>
        <button class="player-btn p3" onclick="startGame(3)"><span class="icon">ğŸŸ¢</span>í”Œë ˆì´ì–´ 3</button>
        <button class="player-btn p4" onclick="startGame(4)"><span class="icon">ğŸŸ¡</span>í”Œë ˆì´ì–´ 4</button>
    </div>
    <div class="bonus-section">
        <button class="bonus-btn" id="bonusBtn" onclick="showBonus()">ğŸ ë³´ë„ˆìŠ¤ ì„œë¹„ìŠ¤ ë°›ê¸°</button>
        <p class="progress-text" id="progressText">ë³´ë¬¼ ë°œê²¬: 0 / 4</p>
    </div>
</div>

<!-- ====== ê²Œì„ í™”ë©´ ====== -->
<div id="gameView">
    <div class="game-header">
        <button class="back-btn" onclick="goBack()">â† ë¡œë¹„</button>
        <h2 id="mapTitle">í”Œë ˆì´ì–´ 1</h2>
        <div class="step-counter">ê±¸ìŒ: <span id="stepCount">0</span></div>
    </div>

    <div id="map"></div>
    <div class="fog-overlay" id="fogOverlay"></div>
    <div class="heartbeat-border" id="heartbeatBorder"></div>
    <div class="treasure-glow" id="treasureGlow"></div>

    <div class="walking-indicator" id="walkingIndicator">
        <div class="walk-dots"><span></span><span></span><span></span></div>
        <span>ì´ë™ ì¤‘...</span>
    </div>

    <div class="hud">
        <div class="hud-top">
            <div>
                <div class="distance-text" id="distanceText">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì´ë™í•˜ì„¸ìš”</div>
                <div class="hint-text" id="hintText">í´ë¦­í•œ ìœ„ì¹˜ë¡œ ê±¸ì–´ê°‘ë‹ˆë‹¤</div>
            </div>
            <div class="compass" id="compass">
                <span class="compass-n">N</span>
                <div class="compass-arrow" id="compassArrow"></div>
            </div>
        </div>
        <div class="distance-bar-container">
            <div class="distance-bar" id="distanceBar"></div>
        </div>
    </div>
</div>

<!-- ====== ëª¨ë‹¬ ====== -->
<div class="modal-overlay" id="foundModal">
    <div class="modal">
        <div class="treasure-icon">ğŸ‰</div>
        <h2>ë³´ë¬¼ ë°œê²¬!</h2>
        <p id="foundMsg">ì¶•í•˜í•©ë‹ˆë‹¤!</p>
        <button onclick="closeFoundModal()">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<div class="modal-overlay" id="bonusModal">
    <div class="modal bonus-modal">
        <div class="treasure-icon">ğŸ†ğŸŠğŸ†</div>
        <h2>ì „ì› ë³´ë¬¼ ë°œê²¬!</h2>
        <p>4ëª… ëª¨ë‘ ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤! íŠ¹ë³„ ë³´ë„ˆìŠ¤ë¥¼ ë“œë¦½ë‹ˆë‹¤!</p>
        <div class="coupon"><div class="label">íŠ¹ë³„ í• ì¸ ì¿ í°</div>ğŸ« 50% OFF</div>
        <p style="font-size:0.85rem;">ì¿ í°ì½”ë“œ: KNU-TREASURE-2026</p>
        <button onclick="closeBonusModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìƒìˆ˜ & ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAMPUS_CENTER = [35.8882, 128.6107];
const CAMPUS_BOUNDS = { latMin: 35.8840, latMax: 35.8930, lngMin: 128.6050, lngMax: 128.6170 };
const FIND_RADIUS = 50;
const WALK_SPEED = 15;       // í•œ ìŠ¤í…ë‹¹ ì´ë™í•  ë¯¸í„°
const STEP_INTERVAL = 60;    // ìŠ¤í… ê°„ê²© ms (ì‘ì„ìˆ˜ë¡ ë¹ ë¦„)

const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
const playerNames = ['í”Œë ˆì´ì–´ 1', 'í”Œë ˆì´ì–´ 2', 'í”Œë ˆì´ì–´ 3', 'í”Œë ˆì´ì–´ 4'];
const treasureEmojis = ['ğŸ’', 'ğŸ‘‘', 'ğŸº', 'â­'];

let players = Array.from({length: 4}, () => ({ found: false, treasure: null }));
let currentPlayer = null;
let map = null;
let playerMarker = null;
let treasureMarker = null;
let radiusCircle = null;
let hintCircle = null;

let playerPos = null;         // í˜„ì¬ í”Œë ˆì´ì–´ ìœ„ì¹˜ [lat, lng]
let walkAnimation = null;     // ê±·ê¸° ì• ë‹ˆë©”ì´ì…˜ ID
let isWalking = false;
let stepCount = 0;
let footprints = [];          // ë°œìêµ­ ë ˆì´ì–´ë“¤
let pathLine = null;          // ì´ë™ ê²½ë¡œ ì„ 

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìœ í‹¸ë¦¬í‹°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function getBearing(lat1, lng1, lat2, lng2) {
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const y = Math.sin(dLng) * Math.cos(lat2 * Math.PI / 180);
    const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
              Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLng);
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function lerpLatLng(from, to, t) {
    return [from[0] + (to[0] - from[0]) * t, from[1] + (to[1] - from[1]) * t];
}

function randomCampusLocation() {
    return [
        CAMPUS_BOUNDS.latMin + Math.random() * (CAMPUS_BOUNDS.latMax - CAMPUS_BOUNDS.latMin),
        CAMPUS_BOUNDS.lngMin + Math.random() * (CAMPUS_BOUNDS.lngMax - CAMPUS_BOUNDS.lngMin)
    ];
}

function initTreasures() {
    for (let i = 0; i < 4; i++) players[i].treasure = randomCampusLocation();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(num) {
    currentPlayer = num - 1;
    if (players[currentPlayer].found) {
        alert(playerNames[currentPlayer] + 'ì€(ëŠ”) ì´ë¯¸ ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!');
        return;
    }

    stepCount = 0;
    playerPos = null;
    footprints = [];
    document.getElementById('stepCount').textContent = '0';
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameView').style.display = 'block';
    document.getElementById('mapTitle').textContent =
        playerNames[currentPlayer] + ' ' + treasureEmojis[currentPlayer];

    initMap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§€ë„ ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap() {
    if (map) map.remove();

    map = L.map('map', { zoomControl: false }).setView(CAMPUS_CENTER, 17);
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap', maxZoom: 19
    }).addTo(map);

    // ìº í¼ìŠ¤ ê²½ê³„
    L.rectangle([
        [CAMPUS_BOUNDS.latMin, CAMPUS_BOUNDS.lngMin],
        [CAMPUS_BOUNDS.latMax, CAMPUS_BOUNDS.lngMax]
    ], { color: playerColors[currentPlayer], weight: 2, fillOpacity: 0.03, dashArray: '8 4' }).addTo(map);

    // ë³´ë¬¼ íŒíŠ¸ ì˜ì—­
    const treasure = players[currentPlayer].treasure;
    hintCircle = L.circle(treasure, {
        radius: 150, color: '#f5af19', fillColor: '#f5af19',
        fillOpacity: 0.06, weight: 1, dashArray: '4 4'
    }).addTo(map);

    // ì´ë™ ê²½ë¡œ ë¼ì¸
    pathLine = L.polyline([], {
        color: playerColors[currentPlayer], weight: 3, opacity: 0.5, dashArray: '6 8'
    }).addTo(map);

    map.on('click', onMapClick);

    // UI ì´ˆê¸°í™”
    document.getElementById('distanceText').textContent = 'ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì´ë™í•˜ì„¸ìš”';
    document.getElementById('hintText').textContent = 'ë…¸ë€ ì ì„  ì› ì•ˆì— ë³´ë¬¼ì´ ìˆìŠµë‹ˆë‹¤!';
    document.getElementById('distanceBar').style.width = '0%';
    document.getElementById('fogOverlay').className = 'fog-overlay';
    document.getElementById('heartbeatBorder').className = 'heartbeat-border';
    document.getElementById('treasureGlow').style.display = 'none';

    setTimeout(() => map.invalidateSize(), 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§€ë„ í´ë¦­ â†’ ê±·ê¸° ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onMapClick(e) {
    const target = [e.latlng.lat, e.latlng.lng];

    // ì²« í´ë¦­ì´ë©´ ë°”ë¡œ ìœ„ì¹˜ ì„¤ì •
    if (!playerPos) {
        playerPos = target;
        placePlayer(playerPos);
        updateGameUI();
        return;
    }

    // ì´ë¯¸ ê±·ëŠ” ì¤‘ì´ë©´ ìƒˆ ëª©ì ì§€ë¡œ ë³€ê²½
    if (walkAnimation) {
        cancelAnimationFrame(walkAnimation);
        walkAnimation = null;
    }

    walkTo(target);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë¶€ë“œëŸ¬ìš´ ê±·ê¸° ì• ë‹ˆë©”ì´ì…˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function walkTo(target) {
    const start = [...playerPos];
    const totalDist = getDistance(start[0], start[1], target[0], target[1]);
    const totalSteps = Math.max(1, Math.ceil(totalDist / WALK_SPEED));
    let currentStep = 0;

    // ë‚˜ì¹¨ë°˜ ì—…ë°ì´íŠ¸
    const bearing = getBearing(start[0], start[1], target[0], target[1]);
    document.getElementById('compassArrow').style.transform = `rotate(${bearing}deg)`;

    isWalking = true;
    document.getElementById('walkingIndicator').classList.add('show');

    function step() {
        currentStep++;
        const t = Math.min(currentStep / totalSteps, 1);
        // ease-out íš¨ê³¼
        const eased = 1 - Math.pow(1 - t, 2);
        playerPos = lerpLatLng(start, target, eased);

        // í”Œë ˆì´ì–´ ë§ˆì»¤ ì´ë™
        placePlayer(playerPos);

        // ê²½ë¡œ ë¼ì¸ ì—…ë°ì´íŠ¸
        pathLine.addLatLng(playerPos);

        // ë°œìêµ­ ìƒì„± (5ìŠ¤í…ë§ˆë‹¤)
        stepCount++;
        document.getElementById('stepCount').textContent = stepCount;
        if (stepCount % 5 === 0) {
            addFootprint(playerPos, bearing);
        }

        // ì¹´ë©”ë¼ ë¶€ë“œëŸ½ê²Œ ë”°ë¼ê°€ê¸°
        map.panTo(playerPos, { animate: true, duration: 0.1, easeLinearity: 0.5 });

        // ê²Œì„ UI ì—…ë°ì´íŠ¸
        updateGameUI();

        // ë³´ë¬¼ ë°œê²¬ ì²´í¬
        const treasure = players[currentPlayer].treasure;
        const dist = getDistance(playerPos[0], playerPos[1], treasure[0], treasure[1]);
        if (dist <= FIND_RADIUS) {
            isWalking = false;
            document.getElementById('walkingIndicator').classList.remove('show');
            foundTreasure();
            return;
        }

        if (currentStep < totalSteps) {
            walkAnimation = setTimeout(step, STEP_INTERVAL);
        } else {
            isWalking = false;
            document.getElementById('walkingIndicator').classList.remove('show');
            walkAnimation = null;
        }
    }

    step();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í”Œë ˆì´ì–´ ë§ˆì»¤ ë°°ì¹˜/ì´ë™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placePlayer(pos) {
    const color = playerColors[currentPlayer];

    if (playerMarker) {
        playerMarker.setLatLng(pos);
    } else {
        const icon = L.divIcon({
            html: `<div class="player-dot" style="
                width: 22px; height: 22px; border-radius: 50%;
                background: ${color}; border: 3px solid #fff;
                box-shadow: 0 0 12px ${color}, 0 2px 8px rgba(0,0,0,0.4);
                transition: box-shadow 0.3s;
            "></div>
            <div style="
                position: absolute; top: -2px; left: -2px;
                width: 26px; height: 26px; border-radius: 50%;
                border: 2px solid ${color}; opacity: 0.5;
                animation: ping 1.5s ease-out infinite;
            "></div>
            <style>@keyframes ping { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(2.5); opacity: 0; } }</style>`,
            iconSize: [22, 22], iconAnchor: [11, 11], className: ''
        });
        playerMarker = L.marker(pos, { icon, zIndexOffset: 1000 }).addTo(map);
    }

    // ê°ì§€ ë°˜ê²½
    if (radiusCircle) {
        radiusCircle.setLatLng(pos);
    } else {
        radiusCircle = L.circle(pos, {
            radius: FIND_RADIUS, color, fillColor: color,
            fillOpacity: 0.08, weight: 1
        }).addTo(map);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°œìêµ­ ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addFootprint(pos, bearing) {
    const foot = stepCount % 10 < 5 ? 'ğŸ‘£' : 'ğŸ‘£';
    const icon = L.divIcon({
        html: `<div style="font-size: 0.7rem; opacity: 0.4; transform: rotate(${bearing}deg);">${foot}</div>`,
        iconSize: [12, 12], iconAnchor: [6, 6], className: 'footprint-marker'
    });
    const marker = L.marker(pos, { icon, interactive: false }).addTo(map);
    footprints.push(marker);

    // ì˜¤ë˜ëœ ë°œìêµ­ ì œê±°
    if (footprints.length > 30) {
        map.removeLayer(footprints.shift());
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ UI ì—…ë°ì´íŠ¸ (ê±°ë¦¬, ì•ˆê°œ, ì‹¬ë°• ë“±)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGameUI() {
    if (!playerPos) return;

    const treasure = players[currentPlayer].treasure;
    const dist = getDistance(playerPos[0], playerPos[1], treasure[0], treasure[1]);
    const distEl = document.getElementById('distanceText');
    const hintEl = document.getElementById('hintText');
    const bar = document.getElementById('distanceBar');
    const fog = document.getElementById('fogOverlay');
    const hb = document.getElementById('heartbeatBorder');
    const glow = document.getElementById('treasureGlow');
    const gameView = document.getElementById('gameView');

    const distStr = dist < 1000 ? Math.round(dist) + 'm' : (dist / 1000).toFixed(1) + 'km';

    // ê±°ë¦¬ ë°”: ìµœëŒ€ 500m ê¸°ì¤€
    const barPct = Math.max(0, Math.min(100, (1 - dist / 500) * 100));
    bar.style.width = barPct + '%';

    if (dist <= FIND_RADIUS) {
        distEl.innerHTML = `<span class="temp-hot">ğŸ”¥ ${distStr} - ë³´ë¬¼ ë°œê²¬!</span>`;
        hintEl.textContent = '';
        bar.style.background = '#e74c3c';
        fog.className = 'fog-overlay very-close';
        hb.className = 'heartbeat-border very-close';
        glow.style.display = 'block';
        gameView.classList.add('screen-shake');
        setTimeout(() => gameView.classList.remove('screen-shake'), 500);
    } else if (dist <= 100) {
        distEl.innerHTML = `<span class="temp-hot">ğŸ”¥ ${distStr} - ë§¤ìš° ëœ¨ê±°ì›Œ!</span>`;
        hintEl.textContent = 'ê±°ì˜ ë‹¤ ì™”ì–´ìš”! ì¡°ê¸ˆë§Œ ë”!';
        bar.style.background = 'linear-gradient(90deg, #e74c3c, #f39c12)';
        fog.className = 'fog-overlay very-close';
        hb.className = 'heartbeat-border very-close';
        glow.style.display = 'block';
        // ê°€ê¹Œìš¸ ë•Œ ì‚´ì§ í”ë“¤ë¦¼
        if (Math.random() > 0.7) {
            gameView.classList.add('screen-shake');
            setTimeout(() => gameView.classList.remove('screen-shake'), 300);
        }
    } else if (dist <= 200) {
        distEl.innerHTML = `<span class="temp-warm">ğŸŒ¡ï¸ ${distStr} - ëœ¨ê±°ì›Œ!</span>`;
        hintEl.textContent = 'ê°€ê¹Œì›Œì§€ê³  ìˆì–´ìš”!';
        bar.style.background = 'linear-gradient(90deg, #f39c12, #f5af19)';
        fog.className = 'fog-overlay close';
        hb.className = 'heartbeat-border active';
        glow.style.display = 'none';
    } else if (dist <= 400) {
        distEl.innerHTML = `<span class="temp-cool">â„ï¸ ${distStr} - ì°¨ê°€ì›Œ</span>`;
        hintEl.textContent = 'ì•„ì§ ë©€ì–´ìš”... ë…¸ë€ ì› ì•ˆì„ íƒìƒ‰í•´ë³´ì„¸ìš”.';
        bar.style.background = '#3498db';
        fog.className = 'fog-overlay';
        hb.className = 'heartbeat-border';
        glow.style.display = 'none';
    } else {
        distEl.innerHTML = `<span class="temp-cold">ğŸ§Š ${distStr} - ë§¤ìš° ì°¨ê°€ì›Œ!</span>`;
        hintEl.textContent = 'ë„ˆë¬´ ë©€ì–´ìš”! ë‹¤ë¥¸ ë°©í–¥ìœ¼ë¡œ ê°€ë³´ì„¸ìš”.';
        bar.style.background = '#2980b9';
        fog.className = 'fog-overlay';
        hb.className = 'heartbeat-border';
        glow.style.display = 'none';
    }

    // ë³´ë¬¼ ë°©í–¥ ë‚˜ì¹¨ë°˜
    const bearingToTreasure = getBearing(playerPos[0], playerPos[1], treasure[0], treasure[1]);
    document.getElementById('compassArrow').style.transform = `rotate(${bearingToTreasure}deg)`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³´ë¬¼ ë°œê²¬!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function foundTreasure() {
    const treasure = players[currentPlayer].treasure;

    // ë³´ë¬¼ ë§ˆì»¤
    const icon = L.divIcon({
        html: `<div style="font-size: 2.5rem; animation: bounceIn 0.6s cubic-bezier(0.175,0.885,0.32,1.275);">
            ${treasureEmojis[currentPlayer]}
        </div>
        <style>@keyframes bounceIn {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            60% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }</style>`,
        iconSize: [40, 40], iconAnchor: [20, 20], className: ''
    });
    treasureMarker = L.marker(treasure, { icon, zIndexOffset: 2000 }).addTo(map);

    // ì¤Œì¸
    map.flyTo(treasure, 18, { duration: 1 });

    players[currentPlayer].found = true;
    spawnParticles();

    setTimeout(() => {
        document.getElementById('foundMsg').textContent =
            playerNames[currentPlayer] + 'ì´(ê°€) ' + treasureEmojis[currentPlayer] +
            ' ë³´ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!\nì´ ' + stepCount + 'ê±¸ìŒ ì´ë™!';
        document.getElementById('foundModal').classList.add('show');
    }, 1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íŒŒí‹°í´
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles() {
    const emojis = ['ğŸ‰', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸŠ', 'â­', 'ğŸ†'];
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const p = document.createElement('div');
            p.className = 'particle';
            p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            p.style.left = Math.random() * 100 + 'vw';
            p.style.top = '-20px';
            p.style.animationDuration = (1.5 + Math.random()) + 's';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 3000);
        }, i * 80);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ëª¨ë‹¬ & ë¡œë¹„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeFoundModal() {
    document.getElementById('foundModal').classList.remove('show');
    goBack();
}
function closeBonusModal() {
    document.getElementById('bonusModal').classList.remove('show');
}

function goBack() {
    if (walkAnimation) { clearTimeout(walkAnimation); walkAnimation = null; }
    isWalking = false;
    document.getElementById('gameView').style.display = 'none';
    document.getElementById('lobby').style.display = 'flex';
    if (map) { map.remove(); map = null; }
    playerMarker = null; treasureMarker = null; radiusCircle = null; hintCircle = null;
    pathLine = null; footprints = [];
    updateLobbyUI();
}

function updateLobbyUI() {
    const btns = document.querySelectorAll('.player-btn');
    let found = 0;
    players.forEach((p, i) => { if (p.found) { btns[i].classList.add('found'); found++; } });
    document.getElementById('progressText').textContent = `ë³´ë¬¼ ë°œê²¬: ${found} / 4`;
    if (found === 4) document.getElementById('bonusBtn').classList.add('active');
}

function showBonus() {
    spawnParticles();
    document.getElementById('bonusModal').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initTreasures();
</script>

</body>
</html>
